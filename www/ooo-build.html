<!doctype html PUBLIC "-//W3C//DTD HTML 4.0//EN">

<html lang="en">
  <head>
    <meta lang="en" http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>About ooo-build</title>
  </head>

  <body>
    <h1>About ooo-build</h1>
    
    <h2 id="section-0">0. Contents</h2>
    <ol>
       <li><a href="#section-1">Why ooo-build</a></li>
       <li><a href="#section-2">Getting involved</a></li>
<!-- FIXME - need structural docs on ooo-build and how it works -->
       <li><a href="#section-3">Releasing</a></li>
       <li><a href="#section-4">Moving to a new OO.o version</a></li>
       <li><a href="#section-5">Areas for improvement</a></li>
    </ol>

    <h2 id="section-1">1. Why ooo-build</h2>
    <p>
      There are a number of reasons for the existence of ooo-build:
    </p>
      <ol>
        <li>CVS doesn't scale
        <li>OO.o process is too slow
        <li>build / package infrastructure
        <li>lack of interest in up-streaming
      </ol>
    <h3 id="section-1.1">1.1 CVS doesn't scale</h3>
    <p>	
      A simple cvs tag of the whole of the OO.o tree can take several
      hours to complete; thus if you want to have a very extensive patch
      set against OO.o you cannot work at a sensible speed. All cvs
      operations, branching, merging, re-synching even simple updating,
      take a very considerable time. Working from a separate base tar.gz
      and a flexible patching system allows the maintenance of a branch
      very much more easily.
    </p>
    <p>
      In fact, it's entirely possible that cvs does scale to projects
      the size of OO.o - but due to (apparently unfixable) design
      inefficiencies in Source-Cast [ having the cvs data remote via
      NFS from the cvs server ], we have serious performance problems.
      See <a href="http://www.openoffice.org/issues/show_bug.cgi?id=24771">
      here</a> for more information.
    </p>
    <h3 id="section-1.2">1.2 OO.o process is too slow</h3>
    <p>	
      Why do we have to have a branch, and a large patch set at all ?
      why can't we just work directly from OO.o CVS.
    </p>
    <p>
      There are several answers here: primarily that CVS commits are
      extremely restricted, the approval process from IssueZilla submit
      to eventual CWS commit, to CWS merge takes a matter of weeks; this
      is no way to create excitement, and provide fast problem fixes.
      Furthermore, there are constraints to merging to a stable branch
      that disallow many changes. Large changes cannot happen eg. (a
      base vtable change, new icons) since Sun have to ship binary 
      bug fix updates - which are required to be reasonably small
      (ie. not all of OO.o again).
    </p>
    <p>
      Furthermore, Sun will only accept patches after receipt of a
      posted / FAXed, signed JCA. While we feel the JCA is a vital
      to OO.o and mandate it's use for ooo-build commits, we are
      happy to prune this postal / processing / CVS account bug ticket
      creation / CVS account bug ticket assignment to collab.net / CVS
      account creation / commit latency. With assurance of an in-flight
      JCA - we can create a CVS account quickly and get you working with
      a handful of hours.
    </p>
    <p>
      Sun has a need for a highly stable / buildable branch from which
      they can make releases. There are two approaches to get a
      stable/buildable branch:
      <ul>
        <li>A. Mandate stringent testing, code review, debug builds, and
	highly restricted commit access.
	<li>B. Encourage a culture of carefulness, and highly unrestricted
	commit access.
      </ul><p>
      While B. results in frequent, temporary breakage, this is soon fixed,
      and life is fast, smooth and happy. The existing situation: A. leads
      to communal frustration / strangulation - however it does provide a
      stable branch at most times.
    </p>
    <p>
      Of course - <i>hopefully</i> at some time in the future problem <a
      href="section-1.1">1.1</a> may get fixed - at which point keeping a
      branch in OO.o cvs that allowed sensible communal development, while
      allowing merge-backs to stable would be feasible.
    </p>
    <h3 id="section-1.3">1.3 build / package infrastructure</h3>
    <p>
      The core OO.o build process is not easy to use, and the packaging
      process on Unix is anachronistic, and inflicts incredible pain on
      sysadmins and users. Thus, this has to be worked around externally
      to OO.o. This is a substantial amount of work - unfortunately, it
      seems the re-creation of a Unix build is also a pending internal
      task - hopefully this will not result in an even bigger mess of
      alternative packaging schemes.
    </p>
    <h3 id="section-1.4">1.4 flexible staging ground for patches in
    progress</h3> <p>
      We have introduced a way to select a subset of patches to apply to
      a particular build.  For example, Ximian uses a set of patches to
      use CUPS as the printing system, which Debian, as a more general
      distribution cannot do, but both packages use the fontconfig support.
    </p>
    <p>
      It also gives the patches a chance to be tested by a wider user 
      community while they await integration into the main version.
    </p>
    <h3 id="section-1.5">1.5 lack of interest in up-streaming</h3>
    <p>
      There have been for many years, very many patches against OO.o to
      do all manner of useful things. Many of these have been submitted
      under the JCA. The pace of adoption of these changes is really
      depressingly slow; and the level of engagement with external
      contributors poor. In some cases whole chunks of functionality
      have been re-written internally without reference to, acknowledgement
      of, or discussion with the original author - this phenomenon
      continues apace.
    </p>

    <h2 id="section-2">2. Getting involved</h2>

    <h3 id="section-2.1">2.1 Communication</h3>

    <p>
      Without communication it's impossible to co-ordinate what is being
      done. It's also impossible to have any confidence that your patch
      will be useful / nicely designed. To try and overcome this, and to
      encourage each other - we hang out on channel #OpenOffice.org on
      irc.freenode.net, you'll soon get to know the team. See also
      <a href="name-account.html">here</a> to see who is whom.
    </p>
    <p>
      We also have a mailing list - which you can subscribe to <a
      href="http://lists.ximian.com/mailman/listinfo/openoffice">here</a>,
      where we discuss various issues related to ooo-build.
    </p>

    <h3 id="section-2.2">2.2 First time setup</h3>
    <p>
      So; since the source tar.gz is a snapshot taken from a random user's
      account; you need to switch this to using the anoncvs root; to do this
      cd build/OOO_1_1_0 (eg.) and run <b>bin/re-root .</b> - this will
      switch the CVS/Root directories to use the anon-cvs server. To verify
      that this has worked, do: cat moz/CVS/Root, and check it contains:
      <pre>':pserver:anoncvs@anoncvs.services.openoffice.org:/cvs'</pre>.
    </p>
    <p>
      Since we are interested in diffs from the toplevel - which has no CVS
      directory; we also need to do: <b>export CVSROOT=`cat moz/CVS/Root`</b>
      NB. '`' is a back-tick.
    </p>
    <p>
      It is of course crucial that you or your company have signed and posted
      the JCA; see <a href="http://www.openoffice.org/contributing.html">here</a>.
    </p>
    <p>
      <strong>NB.</strong> the openoffice sources i.e the sources in
      build/OOO_1_1_0 are in openoffice.org anon-cvs server, whereas
      the toplevel files i.e ooo-build/*.* are in gnome cvs server. So
      for openoffice sources you have to set CVSROOT(as above) for
      performing diffs from the toplevel.
    </p>

    <h3 id="section-2.3">2.3 Generating the patch</h3>
    <p>
      Having done this we can make a patch; taking the sample toolbar change
      from <a href="hackers-guide.html#section-5.0">here</a> we would do this:
      <pre>
      cvs -z3 diff -up vcl/source/window/toolbox.cxx | tee ../../patches/OOO_1_1/gui-toolbox-hack.diff
      </pre>
      <p>
        <strong>NB.</strong> to append a patch to an existing diff use <b>tee -a</b>
      </p>
      <p>
        <strong>NB.</strong> to avoid having to type -z3 &amp; -up grab <a
	href="http://primates.ximian.com/~michael/.cvsrc">this</a> and
	put it in ~.
      </p>
      <p>
        If you're going to create or edit many patches, you should
	<a href="quilt.html">try quilt.</a>
      </p>
      <p>
        Also interesting if you edit patches:
	<a href="http://cyberelk.net/tim/patchutils/">patchutils</a>
	and Miles Bader's way of
	<a href="http://mail.gnu.org/archive/html/gnu-arch-users/2003-12/msg01094.html">handling rejects with (x)emacs diff-mode</a>
    <br>

    <h3 id="section-2.4">2.4 Adding to the apply set</h3>
    <p>
	Before committing the patch, we need to submit it to <a
	href="http://www.openoffice.org">IssueZilla</a> (IZ) - this is about the most
	painful bit: re-login (again), hit <i>File an Issue</i>, commit the issue,
	and attach the patch - remember the IZ number.
    </p>
    <p>
      Having created the patch, you then need to edit the relevant apply set; eg.
      <b>patches/OOO_1_1_0/apply</b> and add the patch to a relevant section,
      along with a comment line that describes it - and references the IZ number.
      eg. <pre><b># this adds a nasty hack to the toolbar - #32179
gui-toolbox-hack.diff
</b></pre>
    </p>

    <h3 id="section-2.5">2.5 Committing the new patch to ooo-build</h3>
    <h4 id="section-2.5.1">2.5.1 your first commit to ooo-build</h4>
    <ul>
	<li>Create an ssh key, see <a href="http://sysadmin.gnome.org/users/security.html">
	here</a> for more details. If you have a key already, send that - it probably
	lives in ~/.ssh/id_dsa.pub or ~/.ssh/id_rsa.pub. Two things to note: <b>do not</b>
	send the private key, and <b>do not</b> loose the key (or overwrite it, or ...).
	<li>E-mail this public key file, with your full name, unique-suggested account name
	    and contact E-mail address to <a href="mailto:michael@ximian.com">
	    michael@ximian.com</a>.
	<li>For more information on this process &amp; details on creating a sensible
	    account name see <a href="http://developer.gnome.org/doc/policies/accounts/requesting.html">
	    here</a>
	<li>If you overlap in European time poke michael / haggai on IRC.
	<li>When you have a CVS account, you will need to switch 'ooo-build'
	to the new root before you can commit, so run:
<pre>ooo-build/bin/re-root ooo-build ':ext:<b><i>UserName</i></b>@cvs.gnome.org:/cvs/gnome'</pre>
	<li>You will also need to export CVS_RSH=ssh before you can perform
	CVS commands.
      </ul>
    <br/>
    <h4 id="section-2.5.2">2.5.2 how to commit</h4>
    <p>
      First ensure you have a ChangeLog entry in ooo-build/ChangeLog, this
      should look like:
    </p>
      <pre>
2003-10-23  FirstName LastName  &lt;EMail@MyCompany.com&gt;

	* patches/OOO_1_1/gui-toolbox-hack.diff,
	* patches/OOO_1_1_0/apply: add a nasty hack for toolbars.
</pre>
    <p>
      Now, from the toplevel directory run <b>cvs commit</b>, use your
ChangeLog text for the CVS commit message.
    </p>

    <h2 id="section-3">3. Releasing</h2>
    <p>
      When there's a particularly good reason for a release, such as a
      distro needs a stable base / we want to do something potentially
      disruptive, one of the core ooo-build hackers will follow something
      like this process:
    </p>
    <ul>
      <li><p><b>cvs update</b> - get the latest everything</p></li>
      <li><p>Read back through the ChangeLog and update the NEWS file for
      the release, summarizing and attributing the changes.</p></li>
      <li><p>edit configure.in, bump the version in the <b>AM_INIT_AUTOMAKE</b>
      line, incrementing the minor version eg. <b>AM_INIT_AUTOMAKE(ooo-build, X.Y.Z)</b>
	      </p></li>
      <li><p><b>./autogen.sh</b> - this re-builds configure with the version in place.
	      </p></li>
      <li><p><b>make dist</b> - this builds the archive containing everything.</p></li>
      <li><p>Add a line to any handy ChangeLogs saying:</p>
<pre>2019-13-33  Ned Squeers  &lt;ned@sqeers.com&gt;

	* Version X.Y.Z
</pre>
		   <p>so we can easily see where this happened in the flow.</p></li>
      <li><p><b>cvs commit</b> - so what's there is what's there. If there
      was a collision you get to loop to the first stage here, but don't
      re-increment the number.</p></li>
      <li><p><b>cvs -z3 tag OOO_BUILD_X_Y_Z</b> - this leaves a static tag
      so we can reproduce the build at any time and easily diff between
      releases.</p></li>
      <li><p><b>scp ooo-build-X.Y.Z.tar.gz ooo@ooo.ximian.com:/var/www/packages/OOO_1_1_0</b>
      of course, substitute the branch/ver for OOO_1_1_0.</p></li>
      <li><p>It's then customary to announce the release, see the template in
      doc/announce.txt - update all the ***s to the right versions, insert
      the contents of NEWS, fire and forget.</p></li>
    </ul>
   
    <h2 id="section-4">4. Moving to a new OO.o version</h2>
    <p>
      This section is mostly of interest to people helping administer the
      ooo-build package over time, and to avoid the patch set getting too
      tangled and messy.
    </p>
    <p>
      Taking the example of an upgrade from OO.o 1.1.0 to 1.1.1, there
      will be several directories, that should end up containing this:
<pre>
patches/
    OOO_1_1/ - only patches against the latest OOO_1_1_X version
    OOO_1_1_0/ - 'apply' file, and old/stale/different patches
    OOO_1_1_1/ - only an 'apply' file.
</pre>
      So - clearly in order to arrive at this scenario, we have to cvs
add the new OOO_1_1_1 directory and it's apply file (based on the
OOO_1_1_0 apply), and for each patch there are three scenarios:
    <ul>
	<li><strong>obsolete</strong> - already included upstream,
	thus we need to move the patch to the OOO_1_1_0/ directory:
<pre>mv OOO_1_1/foo.diff OOO_1_1_0
cvs remove OOO_1_1/foo.diff
cvs add    OOO_1_1_0/foo.diff</pre>
	<li><strong>conflicts</strong> - we still need the patch but
	will have to re-generate a new version of it. In this case we
<pre>cp OOO_1_1/foo.diff OOO_1_1_0
cvs add    OOO_1_1_0/foo.diff
</pre> and then re-generate the diff for 1.1.1 into OOO_1_1/
	<li><strong>no-conflicts</strong> - no work required.
    </ul>
    </p>
    <p>
      Final caveat: this works nicely for 2 version, but what about 3
      or more, should we move a conflicting patch for 1.1.2 into both
      1.1.1 and 1.1.0 ?. For complex scenarios we can update
      the PATCHPATH in various 'apply' files to avoid excessive patch
      duplication, and prune ancient versions over time.
    </p>

    <h2 id="section-5">5. Areas for improvement</h2>
    <p>
      Of course this has a number of obvious down-sides for you as a
      contributor:
    </p>
      <ul>
        <li><p>Working outside CVS makes up-streaming harder, and commits
            somewhat more painful.</p>
        <li><p>You get no immediate 'official' recognition; no-matter how large
            your contribution is to OO.o. You don't exist in the eyes of the artificial
            OO.o <i>community</i> as ooo-build is not an 'official' project;
            however - we value you more.</p>
      </ul>
    <p>
      Obviously the existing situation is highly sub-optimal, here are some
      possible improvements beyond our control that could be made:
    </p>
    <ol>
	<li><p>accelerating CVS performance - this is a hard task, possible
	  <a href="http://subversion.tigris.org">subversion</a> may solve this
      in due course. A more feasible alternative would to devote resources
      to committing to merging CWS' targeting stable to a parallel playground
      branch in OO.o CVS as well [ thus avoiding painful community merging ].</p></li>

    <li><p>accelerating OO.o CVS account creation, binning ACLs and
	hugely increasing access (&amp; trust); thus we can get more people
	involved more quickly without demoralisation.</p></li>

	<li><p>aggressive interest in working with external people, and merging
	their patches; this involves at a minimum:</p>
	  <ul>
	    <li>Rapid response to design queries.</li>
	    <li>Research and response to other OO.o development streams and
	    their patch sets; discussion of requirements for merging.</li>
	    <li>Clear, interactive, casual access to relevant developers
	    to discuss design before larger changes are attempted.</li>
	  </ul>
	  </li>

	<li><p>recognising the needs of Unix packagers to have substantial
	wrappers / work around OO.o, and allowing them to integrate all of
	it, leaving no need for separate branches.</p></li>
      </ol>

  </body>
</html>
