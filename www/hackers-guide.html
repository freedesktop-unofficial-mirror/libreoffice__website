<!doctype html PUBLIC "-//W3C//DTD HTML 4.0//EN">

<html lang="en">
  <head>
    <meta lang="en" http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>Unofficial OpenOffice Hacker's guide for 1.1</title>
  </head>

  <body>
    <table>
	<tr>
	  <td><b>English</b></td>
	  <td><a href="hackers-guide-1.1-ja.html">Japanese</a></td>
	  <td><a href="hackers-guide-1.1-de.html">German</a></td>
	</tr>
    </table>
    <h1>Unofficial OpenOffice Hacker's guide for 1.1</h1>

    <p>
      Building and hacking on OpenOffice.org (OO.o) entails climbing a
      fairly lengthy incline.  Hopefully this document will make the
      learning curve somewhat steeper and more abrupt, and will
      give you a walking stick to help you out.
    </p>

    <p>
      This document assumes that you'll be using a reasonably current
      Linux system, as a time saving feature.  Real hackers use <a
      href="http://www.gnu.org">Free software</a>, and don't have time
      to read about non-Free stuff.
    </p>

    <p>
      We aim to answer at least the following questions:
    </p>

    <ul>
	<li>How do I build OO.o</li>
	<li>How do I go around a development iteration</li>
	<li>How do I debug it</li>
	<li>How do I send a patch</li>
    </ul>

    <p>
      If you need help getting OO.o build, and you intend to hack on
      it, please join the mailing list <a
      href="http://lists.ximian.com/mailman/listinfo/openoffice">
      here</a> and ask questions there.
    </p>

    <h2 id="section-0">0. Contents</h2>

    <ul>
	<li><a href="#section-1">1. Getting OO.o</a></li>
	<li><a href="#section-2">2. Building OO.o</a></li>
	<li><a href="#section-3">3. Installing OO.o</a></li>
	<li><a href="#section-4">4. Running OO.o</a></li>
	<li><a href="#section-5">5. Hacking OO.o</a></li>
	<li><a href="#section-6">6. Debugging OO.o</a></li>
	<li><a href="#section-7">7. Contributing patches</a></li>
	<li><a href="#section-8">8. Misc. tips</a></li>
	<li><a href="#section-9">9. Useful Links</a></li>
	<li><a href="#section-10">10. IFAQ</a></li>
	<li><a href="#section-11">11. Working with us</a></li>
    </ul>

    <h2 id="section-1">1. Getting OO.o</h2>

    <p>
      There are loads of versions of OO.o, and several choices of
      branch, with multiple outstanding patch sets.
      I recommend you build from up-stream CVS HEAD milestones
      (SRC680 milestones), with patch sets to make them easier to
      build from <a href="packages/SRC680">here</a>.
    </p>
    <p>
      The very latest ooo-build (a small ~1.5Mb build wrapper) can
      be got from CVS thus:
    </p>
    <pre>
    export CVSROOT=':pserver:anonymous@anoncvs.gnome.org:/cvs/gnome'
    cvs login
    cvs -z3 checkout -Pd ooo-build
    </pre>

    <p>
      <strong>Note:</strong> You are going to need to download
      an additional ~170Mb of compressed source, and have ~3Gb
      of space space to unpack and build it in.
    </p>

    <h2 id="section-2">2. Building OO.o</h2>

    <h3 id="section-2.1">2.1. configure</h3>

    <p>
      The build process is pretty complicated; you have a choice
      of commands now; although running both won't actually hurt:
    </p>
    <pre>
      ./autogen.sh # only for the CVS version
      ./configure  # the packaged version
    </pre>
    <p>
      This will guess which branch snapshot you want to build; if
      you have other ideas use the --with-tag option; eg.
      <code>--with-tag=src680-m65</code> for a legacy branch.
    </p>
    <p>
      In particular, building SRC680 requires a recent jdk &amp; a
      version of apache-ant. If you use a Novell system, just do:
      <code>sudo rug in apache-ant</code> Failing that see
      <a href="http://ant.apache.org/bindownload.cgi">
      Ant download</a> &amp; set the ANT environment variable
      appropriately before configuring.
    </p>

    <h3 id="section-2.2">2.2 download</h3>

    <p>
      By the time you've upgraded your system to the point that it
      has all the packages you need to start building OO.o (mozilla,
      recent libart etc. etc.) you're almost at the point that you
      can download the bulk of the source. To do this, after a
      successful configure simply type: <code>./download</code> and wait.
    </p>
    <p>
      If for whatever reason this fails, you can verify your download
      by fetching the equivalent .md5 file &amp; comparing it to
      the result of <code>md5sum &lt;archive&gt;</code>. The source
      archives are <a href="http://ooo.ximian.com/packages/SRC680">
      here</a> - put the source in ooo-build/src.
    </p>

    <h3 id="section-2.3">make</h3>

    <p>
      This is the taxing bit - type <code>make</code> and don't forget
      to press enter. Quite possibly you want to log the output, so
      why not <code>make 2&gt;&amp;1 | tee /tmp/log</code>.
    </p>

    <h2 id="section-3">3. Installing OO.o</h2>

    <p>
      When everything has finished building; you should get some happy
      looking message. The easiest way to install is:
      <code>bin/ooinstall -l &lt;path-to-install-to&gt;</code> I often use
      <code>/opt/OOInstall</code>
    </p>
    <p>
      If you are a packager, you'll want to run <code>make install</code>
      which honours DESTDIR &amp; does other packager-like things.
    <p>

    <h2 id="section-4">4. Running OO.o</h2>

    <p>
      Now wander into <code>/opt/OOInstall/program</code> and do:
      <code>source ./env</code> this will setup your (bash) shell for
      running OO.o directly. Then simply <code>./soffice.bin -writer</code>.
      This is better than running soffice, or a wrapper script since
      it's very easy to use the debugger: <code>gdb soffice.bin</code>.
    </p>

    <h2 id="section-5">5. Hacking OO.o</h2>

    <h3 id="section-5.0">5.0. My first hack</h3>

    <p>
      So - we've built and run OO.o, and we want to prove to ourselves
      that it is in fact possible to hack on it. So in a new terminal
      do this:
    </p>
    <pre>
      cd build/src680-m66
      . ./LinuxIntelEnv.Set.sh
      cd vcl
    </pre>
    <p>
      Now have a hack at vcl/source/window/toolbox2.cxx; I suggest
      adding (eg.) an <code>nPos = 0</code> anywhere before the
      m_aItems.insert in ToolBox::InsertItem( const ResId &rResId ...).
      Then save.
    </p>
    <p>
      You're still in vcl/ yes ? then type 'build debug=true'; wait
      for the scrolling text to stop; (5 seconds?). Now re-run
      <code>soffice -writer</code>. You should notice the effect.
      If not, ensure the previous soffice.bin was dead with
      <code>killall -9 soffice.bin</code>
    </p>
    <p>
      <strong>Note:</strong> for day to day hacking you want to
      just run 'build' inside the source tree. It is also highly
      recommended to work inside a copy of the build tree, and
      generate / test patches in an un-hacked version.
      To copy just the build/src680-m66 directory elsewhere, you
      need to use the <a href="#section-10.4">relocate</a> tool.
    </p>
    
    <h3 id="section-5.1">5.1. Read the Fine manual</h3>

    <p>
      With the power of C++ comes the ability to shoot yourself in the
      foot all the more easily; (and implicitly), cf. <em>Holub,
      Rules for C and C++ programming, McGraw-Hill, 95</em>.
    </p>

    <p>
      The best way to prepare yourself for battle is to read the
      OpenOffice coding guidelines <a
      href="http://tools.openoffice.org/CodingGuidelines.sxw">
      here</a>, and for the easily confused c'tor / d'tor is short for
      constructor / destructor.
    </p>

    <h3 id="section-5.2">5.2. Sending patches</h3>

    <p>
      It is seldom clear which module a patch resides in in bugzilla.
      A quick way to try and work this out is to do:
      <code>cvs status &lt;somefile&gt; | head</code>
      This should give a 'Repository Revision:' line, with a path, the
      2nd fragment of this is the project name,
      <code>ooo-build/bin/owner</code> automates that process for you.
    </p>
    <p>
      In addition, since the mapping of module names to IssueZilla
      tickets is rather contorted &amp; un-documented, if you know
      what module the bug is in, use <a href="http://ooo.ximian.com/bug.html">
      this</a> page to file it.
    </p>

    <h3 id="section-5.3">5.3. Starting the right app</h3>
    <p>
      As you start soffice.bin, there are several useful parameters to
      use to accelerate your debugging experience; particularly
      <code>-writer</code>, <code>-calc</code>, <code>-draw</code>,
      and (the wizardly painful) <code>-impress</code> arguments.
    </p>

    <h3 id="section-5.4">5.4. Understanding D' make (man)</h3>

    <p>
      While the build system is in similar to may other systems, it
      is also perhaps slightly different. The overview is that each
      module is <i>built</i>, and then the results are <i>delivered</i>
      into the <a href="http://www.openoffice.org/dev_docs/source/solver.html">
      solver</a>. Each module builds against the headers
      in the solver. Thus there are a few intricacies.

      <ul>
        <li id="build">
	  <i>build</i> &mdash; this perl script <i>solenv/bin/build.pl</i> is
	  used in conjunction with <a href="#section-5.4.2">prj/build.lst</a>
	  to ensure that every module that is needed is built first.<p>
	  build then un-winds internal module dependencies, and builds
	  each module with a chdir, dmake pair.
	</li>
	<li id="deliver">
	  <i>deliver</i> &mdash; this perl script <i>solenv/bin/deliver.pl</i>
	  installs headers, and libraries (etc.) into the solver, as
	  informed by <a href="#section-5.4.3">prj/d.lst</a>. Crucially
	  deliver ensures that the date stamp on any file that is
	  installed to the solver is the same as that in the module's
	  directory. This ensures, that (particularly for headers) that
	  there is no dependency cascade triggering re-builds in other
	  modules.
	</li>
      </ul>
    </p>

    <h4 id="section-5.4.1">5.4.1 Standard directories</h4>

    <p>
      There are various standard directories and files in most of the
      modules that make up OO.o, here are some of the more useful:

      <ul>
        <li><b>prj</b>
	  <ul>
	    <li>
	       <i>build.lst</i> &mdash; this lists directories to be made,
	       '^#' comments are allowed, the order of the list is
	       immaterial see <a href="#section-5.4.2">detail</a>, it
	       is dictates <i>build</i>'s operation.
	    </li>
	    <li><i>d.lst</i> &mdash; this file describes the <i>deliver</i>
	       process, see <a href="#section-5.4.3">detail</a>.
	    </li>
	  </ul>
	</li>
	<li>
	  <b>util</b> &mdash; typically the util directory is charged with
	  glueing together the sub-libraries for each sub-module into
	  a single large library, adding system library dependencies,
	  building GUI resource files etc. All the work is described in
	  <i>makefile.mk</i>, this is usually the last directory to be
	  built in a project.
	</li>
	<li>
	  <b>inc</b> &mdash; public headers are typically separated
	  into an 'inc' directory, these will be installed into
	  the solver by the 'deliver' phase (using <i>prj/d.lst</i>)
	</li>
      </ul>
    </p>

    <p>
      Build's mode of operation is to invoke 'dmake' in each of the
      projects' directories with a given dependency order. dmake
      then executes the rules in makefile.mk.
    </p>

    <h4 id="section-5.4.2">5.4.2 build.lst</h4>

    <p>
      On first view build.lst looks scary:
      <pre>
vc      vcl : NAS:nas FREETYPE:freetype psprint rsc sot ucbhelper unotools sysui NULL
vc      vcl                      usr1   -       all     vc_mkout NULL
vc      vcl\source\unotypes      nmake  -       all     vc_unot NULL
vc      vcl\source\glyphs        nmake  -       all     vc_glyphs vc_unot NULL
      </pre>
      so we need to try and un-pack what's going on here, which is in fact not
      as odd as it might seem at first glance. Firstly lists are terminated
      by the 'NULL' string. Every line is prefixed by a shortcut which is
      irrelevant.<p>

      <ul>
         <li>
	   First active line contains a ':', this describes the
	   fact that this project (vcl) depends on these other modules
	   'nas', 'freetype', 'psprint' etc. to be built first. This is
	   for inter-project dependencies.
	 </li>
	 <li>
	   Some modules have a CAPITALS:lowercase arrangement; the first
	   segment is a conditional, driven by a space delimited list in
	   the BUILD_TYPE environment variable at build time.
	 </li>
	 <li>
	   Then we have a redundant line 'usr1' [ for fun ? ], in fact
	   only lines containing the magic string 'nmake' are valid after
	   this.
	 </li>
	 <li>
	   The next lines describe internal project directory dependencies
	   and look like:
	     <pre>
[shortcut] [path to dir to build] nmake - [flags] [unique-name] [deps...] NULL
vc           vcl\source\glyphs    nmake -   all     vc_glyphs   vc_unot   NULL
	     </pre>
	   <i>shortcut</i> is not used; <i>flags</i> determines which platforms
	   this builds on; usually single char platform codes: 'dnpum' 'u' being
	   Unix. The higher up the system, the more stuff is flagged 'all'.<p>
	   <i>unique-name</i> this is a magic name, used by other lines to
	   describe an internal dependency. <i>deps...</i> any number of names of
	   other directories in this file, that must be built before this one.
	 </li>
      </ul>
      So we see in the vcl case that <i>vcl\source\unotypes</i> (vc_unot) has
      to be built before <i>vcl\source\glyphs</i> (vc_glyphs). It is
      <b>important</b> to understand that the order of the list is ~immaterial,
      and instead of a simple ordered list, we have a more complex internal
      dependency system &mdash; this contrasts with most other make systems.
    <p>
      There is also documentation <a href="http://tools.openoffice.org/tools/build.html">
      here</a> on it.
    <p>

    <h4 id="section-5.4.3">5.4.3 d.lst</h4>

    <p>
      The syntax of d.lst is more comprehensible than build.lst, it omits
      some default actions, such as copying build.lst into
      <i>inc/&lt;module&gt;/build.lst</i>.<p>
      A line is of the form:
      <pre>
[action]: [arguments]
mkdir:    %_DEST%\inc%_EXT%\external
      </pre>
      where if '[action]:' is omitted, it defaults to the 'copy' action.
      Typical actions are <i>copy</i>, <i>mkdir</i>, <i>touch</i>, <i>hedabu</i>,
      <i>dos</i> and <i>linklib</i>.<p>
      The 'hedabu' action is particularly interesting, inasmuch that it
      cosmetically re-formats the header to shrink it on install (otherwise
      it's much like the copy action).
      <p>
      During the action, various macro variables are expanded some of which are:
      <ul>
        <li>%__SRC% &mdash; distribution directory name eg. <i>unxlngi4.pro</i></li>
	<li>
	  %_DEST% &mdash; absolute path into solver eg.
	  <i>/opt/OpenOffice/OOO_STABLE_1/solver/641/unxlngi4.pro</i>
	</li>
	<li>
	  %_EXT% &mdash; (unusual) way of having minor updates eg. 641.1,
	  typically used to version every base sub-directory.
        </li>
      </ul>
      Typically then, if indeed you need to add a rule (cf. implicit
      directory copies), it will be of the form:
      <pre>
..\%__SRC%\inc\sal\*.h %_DEST%\inc%_EXT%\sal\*.h
      </pre>
      NB. relative paths are relative to the 'prj/' directory.
    </p>

    <h3 id="section-5.6">5.6 Can I get a <code>char *</code>, please?</h3>

    <p>
      Just barely.  OO.o has at least six string wrappers, although the C
      implementations are of little interest:
    </p>

    <ul>
      <li>
	<p>
	  <code>rtl_String</code> &mdash; sal/inc/rtl/string.h<br>
	  "Normal" string plus reference counting.
	  <code>rtlstring-&gt;buffer</code> is useful, as is
	  <code>rtlstring-&gt;length</code>.  This object encapsulates
	  an generic 8bit string - of unknown encoding. Feel free to treat
	  <code>rtlstring-&gt;buffer</code> as your beloved <code>char *</code>.
	</p>
      </li>

      <li>
	<p>
	  <code>OString</code> &mdash; sal/inc/rtl/string.hxx<br>
	  Simply a rtl_String wrapped inside a <code>class</code>; you
	  can use <code>ostring.pData</code> to get at the rtl_String
	  (it's public).  <code>OString</code> has reasonably useful
	  methods for if you need them.
	</p>
      </li>

      <li>
	<p>
	  <code>rtl_uString</code> &mdash; sal/inc/rtl/ustring.h<br>
	  "Normal" Unicode string, similar to rtl_String, and
	  refcounted as well.  However, this one always comes in UCS-2
	  encoding, presumably to be compatible with Java's
	  questionable choices. 
	</p>
      </li>

      <li>
	<p>
	  <code>OUString</code> &mdash; sal/inc/rtl/ustring.hxx<br> 
	  An rtl_uString wrapped inside a <code>class</code>.  This is
	  what most of the OO.o code uses to pass strings around.
	  To convert an <code>OString</code> to an <code>OUString</code>
	  it is necessary to specify the character set of the
	  <code>OString</code> see; <code>sal/inc/rtl/textenc.h</code>
	  &mdash; the only interesting case is <code>RTL_TEXTENCODING_UTF8</code>
	</p>
      </li>

      <li>
        <p>
	  <code>String</code> &mdash; tools/inc/string.hxx<br>
	  This is an obsolete string class, aliased to 'UniString'.
	  It has a number of limitations such as a 64k length limit.
        </p>
      </li>
    </ul>

    <p>
      A couple of conversion functions are really useful here,
      Particularly:
    <p>
    <p><code>rtl::OString aOString = ::rtl::OUStringToOString (aOUString, RTL_TEXTENCODING_UTF8);</code></p>
    <p>And the reverse:</p>
    <p><code>rtl::OUString aOString = ::rtl::OStringToOUString (aOString, RTL_TEXTENCODING_UTF8);</code></p>
   
    <p>
      If you just want to programattically print out a string for
      debugging purposes you probably want to see <a href="#printout">
      this</a>.
    </p>

    <h4 id="section-5.6.2">5.6.2. Examining strings from GDB</h4>

    <p>
      We have already seen that OO.o does not use humble <code>char *</code> 
      strings.  If you thought this was painful enough when writing
      code, wait until you have to debug it.  Here's how to get at
      your strings from gdb/dbx which don't natively handle unicode.
    </p>

    <ul>
      <li>from cvs branch cws_srx645_ooo112fix1 onwards you can use
      <code>(gdb) print dbg_dump(sWhatEver)</code> to print the contents
      of a UniString/ByteString/rtl::OUString/rtl::OString regardless
      of the type when debugging C++ code. See <a
      href="http://qa.openoffice.org/issues/show_bug.cgi?id=17295">
      issue 17295</a> for details.
    </ul>
    Alternatively if this support isn't in your version of OOo yet then...
    <ul>
      <li>rtl_String: just poke at it</li>
      <li>String: &mdash; note, the decl' of this uses the macro
          'UniString' to confuse readers of tools/inc/string.hxx.
	  Luckily programattically we can transparently cast a
	  String to an OUString.
      <li>OString: <i>p str-&gt;pData</i></li>
      <li>OUString, rtl_uString: (great tip from Kevin Hendricks)
      The quickest and best way to dump the string is to do:
      <pre>
      p *theString; # grab the length (2nd field)
      x/&lt;length&gt;s theString-&gt;buffer</pre> eg. for a 20 character
      string we want <code>x/20s theString-&gt;buffer</code>.
      This should print the string as an array of shorts with
      ASCII char values nicely in a column.
      To programatically print a OUString (or String) you need:
      <code id="printout">::rtl::OString tmpStr = OUStringToOString (<i>MyOUString</i>, RTL_TEXTENCODING_UTF8);
fprintf (stderr, "String is '%s'\n", tmpStr.getStr());</code>
      </li>
    </ul>

    <h4 id="section-5.8">5.8. Linkoo &amp; Limitations</h4>
    <p>
      Linkoo is the tool that implements the <code>-l</code>
      functionality of <code>bin/ooinstall</code>. It essentially
      sym-links files of similar names into your local tree,
      allowing a fast development iteration.
    </p>
    <p>
      It is however slightly limited - some of the modules
      cannot be linked for various reasons; these are:
      <code>cppuhelper</code> and <code>configmgr</code>,
      thus in the rare case that these are altered, they
      must be copied manually into <code>/opt/OOInstall/program</code>.
    </p>
    <p>
      In addition symlinks cannot be used for soffice.bin, and
      this is more commonly altered - it has to be installed
      from <code>desktop/unxlngi4.pro/bin/soffice</code> NB.
      with an appended '.bin'
    </p>

    <h2 id="section-6">6. Debugging OO.o</h2>

    <p>
      This section assumes use of gdb, from the console.
    </p>

    <h3 id="section-6.1">6.1. Building with debugging symbols</h3>

    <p>
      OO.o includes a way to add debugging code in per module, via
      the <tt>build debug=true</tt> command in each module.
      Unfortunately this is not recommended to run for the whole
      project, and in addition to including vital debugging symbols
      it also includes scads of assertions, churning warnings, and
      various other checks.
    </p>
    <p>
      Thus if you want debugging symbols for everything, you have to
      hack several makefiles to add debugging symbols, [ NB. this
      makes the OO binaries ~1Gb small and the full build tree ~8Gb
      so beware ], apply this patch:
    </p>
    <pre>
--- solenv/inc/unxlngi4.mk
+++ solenv/inc/unxlngi4.mk
@@ -92,18 +92,18 @@ cc=gcc
 # do not use standard header search paths
 # if installed elsewhere
 .IF "$(BUILD_SOSL)"!=""
-CFLAGS=
+CFLAGS=-g
 .ENDIF
 CFLAGS+=-fmessage-length=0 -c $(INCLUDE)
 # flags for the C++ Compiler
-CFLAGSCC= -pipe -mcpu=pentiumpro
+CFLAGSCC= -g -pipe -mcpu=pentiumpro
 # Flags for enabling exception handling
 CFLAGSEXCEPTIONS=-fexceptions -fno-enforce-eh-specs
 # Flags for disabling exception handling
 CFLAGS_NO_EXCEPTIONS=-fno-exceptions
 
 # -fpermissive should be removed as soon as possible
-CFLAGSCXX= -pipe -mcpu=pentiumpro -fno-for-scope -fpermissive -fno-rtti 
+CFLAGSCXX= -g -pipe -mcpu=pentiumpro -fno-for-scope -fpermissive -fno-rtti 
 
 # HACK: enable Hamburg developers to build on glibc-2.2 machines but compile vs. glibc-2.1 headers
 .IF "$(BUILD_SOSL)"==""
    </pre>
    <p>
      Of course, without debugging symbols gdb becomes even more
      useless. To apply the patch cut and paste the above to /tmp/foo
      and in the base directory:
    </p>
    <p><code>patch -p0 < /tmp/foo</code></p>

    <h3 id="section-6.2">6.2. Setting breakpoints</h3>

    <p>
      Due to the general level of brokenness in gdb, it's most likely
      that setting a breakpoint before running is unlikely to work;
      thus the best scheme is to:
    </p>

    <pre>
gdb ./soffice
break main
run # don't forget the arguments here
# ... traps in main ...
break osl_readFile
continue
    </pre>

    <p>
      Of course, this is never going to work if the code is
      implemented in a library that is dlopened later, which 
      accounts for the vast majority of OO code. Thus, you need
      to trap the code loading and then put the breakpoint in.
      To do that whack a breakpoint in osl_psz_loadModule, and
      suffer.
    </p>

    <p>
      Alternatively if you can instrument the code, it's pretty
      easy to add #include &lt;signal.h&gt; and then put a
      raise (SIGSTOP); somewhere in the code which will trap out
      in the debugger.
    </p>

    <h3 id="section-6.3">6.3. Starting at the beginning</h3>

    <p>
      We start in 'main' with a sal wrapper, that calls
      vcl/source/app/svmain.cxx (SVMain). It invokes Main on
      pSVData-&gt;mpApp; but pSVData is an in-line local. To
      debug this use the pImplSVData global variable. eg:
      <pre>
      p pImplSVData-&gt;maAppData
      </pre>
      This 'Main' method is typically:
      desktop/source/app/app.cxx (Main).
    </p>

    <h3 id="section-6.4">6.4. Examining strings</h3>

    <p>
      The humble char * (that gdb can natively display) is eschewed
      in the object world by wrapping it with innumerable different
      classes that gdb doesn't understand.  Worse, in many cases it
      is extremely difficult even to print the string &mdash; one consequence
      of the appalling decision to go with ucs-2 encoding. There
      are also both mutable and immutable string classes.
    </p>

    <p>
      Please read <a href="#section-5.6.2">section 5.6.2</a> to see
      how strings work in OO.o and to get some debugging tips.
    </p>

    <h3 id="section-6.5">6.5 Getting the build order right</h3>

    <p>
      The build dependencies of the modules are clearly crucial to
      getting a clean build. When you type 'build' in a module, first
      build examines prj/build.list, eg. neon/prj/build.lst:
      <pre>
xh      neon  :  soltools external expat NULL
      </pre>
      this specifies that 'soltools', 'external' and 'expat' have to
      be satisfactorily built and delivered before neon can be built.
      Occasionally these rules get broken, and people don't notice for
      a while.
    </p>

    <h3 id="section-6.6">6.6 It crashes, but only in gdb</h3>

    <p>
      What fun &mdash; you symlinked desktop/unxlngi4.pro/bin/soffice to
      soffice.bin in your install tree didn't you. That works fine
      if you just run it, but it seems gdb unpacks the symlink and
      passes a fully qualified path as argv[0], which defeats the
      hunting for the binary in the path, so it assigns the program
      base path as /opt/OpenOffice/OOO_STABLE_1/desktop/unxlngi4.pro/bin
      and starts looking for (eg. applicat.rdb) in there. Of course
      when it fails to find any setup information, it silently
      crashes somewhere else yards away from the original problem.
    </p>

    <h3 id="section-6.7">6.7 It crashes, but doesn't crash</h3>

    <p>
      For various reasons signal handlers are trapped and life
      can get rather confusing; thus it's best for builders to
      apply something like this:
<pre>
--- sal/osl/unx/signal.c
+++ sal/osl/unx/signal.c
@@ -188,6 +188,8 @@ static sal_Bool InitSignal()
             bSetILLHandler = sal_True;
        }
 
+       bSetSEGVHandler = bSetWINCHHandler = bSetILLHandler = bDoHardKill = sal_False;
+
        SignalListMutex = osl_createMutex();
 
        act.sa_handler = SignalHandlerFunction;

</pre>
      NB. trailing space.
    </p>

    <h3 id="section-6.8">6.8 I can't find the code from the trace</h3>

    <p>
      Some methods, are described as having a special linkage, such that
      they can be used in callbacks; these typically have a prefix:
      'LinkStub', so search for the latter part of the identifier in a
      freetext search. eg.
      <pre>
      IMPL_LINK( Window, ImplHandlePaintHdl, void*, EMPTYARG )
      </pre>
      builds the 'LinkStubImplHandlePaintHdl' method.
    </p>


    <h3 id="section-6.9">6.9 How can I re-build just the files I see in the trace</h3>

    <p>
      Often when you run gdb on a non-debugging build, you can't afford
      to wait, and re-compile (eg.) all of oowriter. Thus we have created
      a small perl helper, with which you can cut and paste method / class
      names you are interested in from the stack, and it'll touch just files
      containing those strings &mdash; for easier re-build. Here is a typical
      debugging workflow:
    </p>
    <pre>
    gdb ./soffice.bin
    ...
    bt
#0  0x40b4e0a1 in kill () from /lib/libc.so.6
#1  0x409acfe6 in raise () from /lib/libpthread.so.0
#2  0x447bcdbd in SfxMedium::DownLoad(Link const&amp;) () from ./libsfx641li.so
#3  0x447be151 in SfxMedium::SfxMedium(String const&amp;, unsigned short, unsigned char, SfxFilter const*, SfxItemSet*) ()
   from ./libsfx641li.so
#4  0x448339d3 in getCppuType(com::sun::star::uno::Reference<com::sun::star::document::XImporter> const*) () from ./libsfx641li.so
...
    quit
    cd base/OOO_STABLE_1/sfx2
    ootouch SfxMedium
    build debug=true
    </pre>
    <p>
      Thus, all files referencing / implementing anything with
      SfxMedium will be touched, and hence rebuilt with debugging
      symbols.
    </p>

    <h3 id="section-6.10">6.10 How can I re-build all the files in one source directory</h3>

    <p>
      If you want to recompile the code in just your current directory, you can
      use the killobj dmake target to remove the object files:
    </p>
    <pre>
    dmake killobj
    dmake
    </pre>

    <h3 id="section-6.11">6.11 It always crashes in sal_XErrorHdl</h3>

    <p>
      You are a victim of asynchronous X error reporting;
      <code>export SAL_SYNCHRONIZE=1</code> will make all the X traffic
      synchronous, and report the error by the method that caused it,
      it'll also make OO.o far slower, and the timing different.
    </p>

    <h3 id="section-6.12">6.12 It silently fails to load my word file</h3>
    <p>
      Caolan suggests: put breakpoints in ww8par.cxx top and tail of
      SwWW8ImplReader::LoadDoc, and confirm that the document gets as far
      as the import filter.
    </p>
    <p>
      A handy human place to put a breakpoint is in 
      SwWW8ImplReader::ReadPlainChars, you can see chunks of text as
      they are read in. Alternatively SwWW8ImplReader::AppendTxtNode as
      each paragraph is inserted.
    </p>

    <h3 id="section-6.13">6.13 How do I use the debug console ?</h3>
    <p>
      So OO.o contains some hefty debugging infrastructure; pictured
      <a href="images/debug-window.png">here</a>. Unfortunately
      enabling it is not altogether trivial. Firstly - none of it is built
      into a product build; so we need to go to re-build some core parts
      of OO.o as non-product builds; and then we need to re-run linkoo
      to link those new builds into our set.
    </p>
    <p>
      First create a debug Environment file; I call it
LinuxIntelEnv.Set.debug:
<pre>
TMPFILE=~/.Env.Set.debug

# Purge .pro bits
sed 's/\.pro//g' LinuxIntelEnv.Set.sh &gt; $TMPFILE
. $TMPFILE
rm $TMPFILE

# Clobber product parts
unset PRODUCT PROSWITCH PROFULLSWITCH 
</pre>
      Now do <code>source ./LinuxIntelEnv.Set.debug</code>, this
      sets up your environment for a non-product build.
    </p>
    <p>
      cd vcl; build dbgutil=true --all
      linkoo <install-path> <here>
    </p>
    <p>
      Now - just run OO.o, and when it's in full-flow, press
      &lt;Alt&gt;-&lt;Shift&gt;-&lt;Control&gt; 'D' in that
      order; this should popup a debugging options window.
      The debugging options
      are subsequently saved to the .dbgsv.init file for the
      next run; you can control the location of that with:
      <code>export DBGSV_INIT=$(HOME)/.dbgsv.init</code> eg. it
      is (unfortunately) a binary file.
    </p>

    <h3 id="section-6.14">6.14 Excel Interop debugging</h3>
    <p>
      This is fairly easy; edit sc/source/filter/inc/biffdump.hxx,
      define EXC_INCL_DUMPER to 1, and re-build 'sc'. Also, copy
      sc/source/filter/excel/biffrecdumper.ini to ~. Then run
      <code>soffice.bin foo.xls</code> and you should get a
      foo.txt with the debug data in it. If you get nothing, you
      need to find/apply sc-biffdump.diff from <a
      href="http://qa.openoffice.org/issues/show_bug.cgi?id=25430">
      here</a>.
    </p>

    <h2 id="section-7">7. Contributing patches</h2>

    <h3 id="section-7.1">7.1. Diff style</h3>

    <p>
      Always use unified diffs 'cvs -z3 diff -u', since they are the
      most readable, (and sensible) types of diff to read and apply.
    </p>

    <h3 id="section-7.2">7.2. Some interaction</h3>

    <p>
      It tends to be a good idea to work out how best to implement
      your fix, and/or discuss it with a developer or two before hand.
      Some of the best ways to do this are to post to <a
      href="mailto:dev@openoffice.org">dev@openoffice.org</a> or lurk
      on IRC at <tt>irc.freenode.net</tt> on the
      <tt>#OpenOffice.org</tt> channel. IRC is an awfully poor
      communication medium, but better than no communication.
      See <a href="name-account.html">here</a> to unwind who is
      whom.
    </p>

    <h3 id="section-7.3">7.3. ooo-build patch creation</h3>
    <p>
      See <a href="ooo-build.html#section-2.2">here</a> for more
      information on our patching infrastructure.
    </p>

    <h3 id="section-7.4">7.4 filing bugs</h3>
    <p>
      See <a href="bug.html">here</a> for a sane / hackers interface
      to OpenOffice's IssueZilla.
    </p>
    <p id="owner">
      Since we can often extract the owner of a module by checking
      for the ADMIN_FILE_OWNER tag; there is a little tool in
      ooo-build: bin/owner &lt;file-name&gt; that helps you
      find out who to E-mail / interact with about a given module;
      it's worth assigning very specifically located bugs to that
      person.
    </p>

    <h2 id="section-8">8. Misc. tips</h2>

    <h3 id="section-8.1">8.1. Getting an OO.o CVS account</h3>

    <p>
      This is the process for getting CVS accounts for the up-stream
      CVS server, ooo-build accounts are handled <a
      href="ooo-build.html#section-2.5.1">differently</a>. To see how
      the issue raising process works see eg. issue <a
      href="http://www.openoffice.org/issues/show_bug.cgi?id=7270">#7270</a>. Having got
      the account setup, you need to tunnel to the secure CVS server
      something like:
    </p>

    <p><code>ssh -f -2 -P -L 2401:localhost:2401 tunnel@openoffice.org sleep 1400 < /dev/null > /dev/null</code></p>

    <p>
      Then you need to change your CVSROOT to point at your local
      machine, since this is the endpoint of the tunnel:
    </p>

    <p><code>:pserver:mmeeks@localhost:/cvs</code></p>

    <p>
      Your account name and password - will be the same as you use for
      filing bugs etc. in the SourceCast system. Login, and ... you'll
      soon notice that you'll need to migrate your CVS settings to the
      new server, to do this without wasting B/W with duplicate
      checkouts do:
    </p>
    <code>bin/re-root /path/to/checkout ":pserver:&lt;account-name-here&gt;@localhost:/cvs"</code>
    <p>
      Of course, to commit anything, you'll need various project
      priviliges - and to battle the bureaucracy.
    </p>

  <h3 id="section-8.2">8.2 Using patch / diff</h3>

  <p>
    Patch/diff are a wonderful tools, however people often provide
    data that confuses them in a messy and difficult to un-tangle
    sort of a way. Here are some hints on untangling the mess:
  </p>
  <ul>
    <li>If at all unsure, run patch with --dry-run first, this will
        appear to do the patching action, but not actually do it
	[ this can give bogus results with compound inter-depending
	  patches, but is extremely useful ].
    <li>Mostly use patch -p0; 0 signifies the number of path
        elements to strip from the beginning of the file path the
	diff points at.
    <li>When you mess up, and have 1/2 of the patch applied and want
        to revert to clean, either remove the files and cvs update,
	or re-patch with the '-R' option, to reverse the effect.
    <li>Sometimes using diff between modules with lots of whitespace
        changes makes the patch hard to read; the '-w' flag to (cvs)
	diff makes this easier.
  </ul>

  <h3 id="section-8.3">8.3 Make clean</h3>

  <p>
    Just use <i>dmake clean</i> in the toplevel directory. In pre
    HEAD versions there was no 'clean' target so instead you had
    to do something (what dmake clean does now) like:
  </p>
  <p><code>find -name 'unxlngi4.pro' -exec rm -Rf {} \; </code></p>

  <h3 id="section-8.4">8.4 CVS setup</h3>

  <p>
    In order to make efficient use of bandwidth, generate sensible
    diffs by default, and follow the trend, you need this in your
    ~/.cvsrc.
  </p>
<pre>
cvs -z3 -q
diff -upN 
update -dP
checkout -P
status -v 
</pre>

    <h3 id="section-8.5">8.5. Adding header files to the build</h3>

    <p>
      Adding header files to the OO.o build is notoriously clunky.  To
      add header files under external/, make sure you list them in
      external/prj/d.lst so that they get copied under the
      solver/641/unxlngi4.pro/inc/external directory when building.
    </p>


    <h3 id="section-8.6">8.6. Finding where to hack</h3>

    <p>
      Often there is some GUI element used near the thing you're
      trying to locate / fix. So, find some sufficiently unusual
      string and search for it in <a href="http://ooo.ximian.com/lxr">LXR</a>'s
      <b>text</b> search; this should reveal an identifier related
      to that string; eg. SID_AUTOFORMAT, or FN_NUM_BULLET_ON.
      Having obtained that, do a new text search for that string,
      and you'll find the usage [ or a chained define to something
      else ]. For eg. menus/toolbar buttons the functionality is
      usually in a case statement eg. case SID_AUTOFORMAT: ...
    </p>

    <h2 id="section-9">9. Useful links</h2>

    <h3 id="section-9.1">9.1. www.OpenOffice.org</h3>

    <p>
      While much of the initial openoffice.org structure seems not to
      be orientated towards hackers, there is much useful <a
      href="http://www.openoffice.org/documentation.html">
      documentation</a> if you dig for it.
    </p>

    <p>
      For OO.o news, and a distinctive perspective on OO.o see
      <a href="http://www.ooodocs.org">ooodocs.org</a>.
    </p>

    <p>
      Other related pages are:

      <a href="http://ooodi.sourceforge.net/">OOODI</a>a Gtk+ Dictionary installer.

      <a href="http://ooextras.sourceforge.net">OOExtras</a> provides
      extra templates, macros, and clip art.

      <a href="http://ooqstart.sourceforge.net">Quickstart applet</a> for GNOME
      (and <a href="http://segfaultskde.berlios.de/index.php?content=oooqs">KDE</a>).

      <a href="http://dict.progbits.com">Dictionaries &amp Docs</a> from Kevin Hendricks.
    <p>

    <h3 id="section-9.2">9.2. Patch archives</h3>

    <p>
      While productising various releases of OpenOffice, different
      projects have come up with (quite huge) patch sets against OO.o.
      Mercifully they are starting to get folded back in at a greater
      rate, so no patches should be necessary to HEAD to build
      it, similarly many have got into OOO_STABLE_1. It may be
      necessary to use some/all of these nevertheless.
    </p>

    <ul>
      <li>
	<a href="http://ooo.ximian.com">Ximian</a>'s OO.o patches and build
	tools / snapshots are all available as <a
	href="http://ooo.ximian.com/packages">packages</a>; or
	as <a href="http://ooo.ximian.com/patches">patches</a>.
      </li>
      <li>
	<a href="http://www.debian.org">Debian</a>'s helpful OO.o <a
	href="http://www.linux-debian.de/openoffice/">page</a>, with
	patches. And also Debian <a
	href="http://cvs.debian.org/oo-deb/debian/?cvsroot=debian-openoffice">
	CVS</a>.
      </li>
      <li>
	<a href="http://www.linux-mandrake.com">Mandrake</a>'s OO.o <a
        href="http://cvs.mandrakesoft.com/cgi-bin/cvsweb.cgi/SPECS/OpenOffice.org/">
        patch archive</a>.
      </li>
      <li>
        <a href="http://www.freebsd.org/cgi/cvsweb.cgi/ports/editors/openoffice/#dirlist">
	FreeBSD</a>'s OO.o port patches.
      </li>
      <li>
	Red Hat's .spec file (based on Mandrake's) is also worth a
	read, from their <a
	href="http://rawhide.redhat.com/pub/redhat/linux/rawhide/SRPMS/SRPMS/openoffice-1.0.1-6.src.rpm">SRPM</a>.
      </li>
      <li>
        People wanting to localize OO.o should study these
	<a href="ftp://ftp.linux.cz/pub/linux/people/pavel_janik/OpenOffice.org_1.0.1_CZ/build-13/build/Patches">
	patches</a> from Pavel Janik.
      </li>
    </ul>

    <h2 id="section-10">10. (Infrequently) FAQ</h2>

    <p>
      So no-one ever asked me these, I just made them up to astro-turf
      a bit (safer, wipe-clean, more durable questions).
    </p>

    <h3 id="section-10.1">10.1. Why do branches like 'mws_srx644' have odd numbers in them ?</h3>

    <p>
      By consulting various oracles, entrails etc. it transpires that
      in theory this number increments weekly, there being weekly
      freezes and hence solvers, development environments.  However -
      in recent time the process of solidifying a single build for
      wider release, has taken longer than a week &mdash; creating a
      quandary, and a mixed alphanumeric release tag. The 'mws' stands
      for 'Master Workspace'.
    </p>

    <h3 id="section-10.2">10.2. Why does the <b>build</b> require Java ?</h3>

    <p>
      Essentially it seems there are a lot of XML files involved in
      component registration, and various other services. It turns
      out that using Java is just an easy way to get this manipulation
      done simply. Also, Java can be used nicely at run-time if it's
      on the machine.
    </p>
    <p>
      But from tag SRC680_m44 onwards there is an 
      <a href="http://www.openoffice.org/issues/show_bug.cgi?id=28773">
      alternative python script</a> included to address the issue of processing
      these XML files used for registration, so it should be possible to build
      versions after that date without java, though your milage may vary as the
      default build is with java.
    </p>

    <h3 id="section-10.3">10.3. Why is [t]csh so broken ?</h3>

    <p>
      This is rather inscrutable; some particularly curious brokenness
      would be the way piping commands on stdin is crucially different
      to inputting them from the tty thus:
      <code>echo 'echo #define DLL_NAME "libsch641li.so" &gt;./foo.hxx' | /bin/tcsh -s</code>
      fails to do anything whereas typing the same thing into the shell
      works just fine. Even more oddly:
      <code>tcsh -fc 'echo #define DLL_NAME "libsch641li.so" &gt;./foo.hxx'</code>
      does do the right thing. See also <a
      href="http://www.faqs.org/faqs/unix-faq/shell/csh-whynot/">csh</a>.
    </p>

    <h3 id="section-10.4">10.4. I just tried to re-locate the build, why doesn't it work ?</h3>

    <p>
      The simple answer is: you need to run <code>relocate /path/to/new/build</code>;
      another more complex answer is:
    </p>
    <p>
      Well, <b>assuming</b> you have re-configured things (LinuxIntelEnv.Set will
      need paths tweaking too &mdash; and re-importing to your shell) &mdash; then it's most 
      likely down to the ubiquitous non-relative paths, coded in lots
      of generated / built files, particularly '.dpc*' (dependency)
      files. Try:
      <pre>
find -name '*.dpc*' -exec rm {} \;
      </pre>
    </p>
    <p>
      The stlport does some really <a href="#section-10.10">broken</a> things, so
      you will also need to edit the 'stl_gcc.h' inside the solver/, and replace the
      two path instances there (see inc/stl/config/stl_gcc.h).
    </p>

    <h3 id="section-10.5">10.5 CVS says 'Fatal Error aborting. [acc] no such user', why ?</h3>

    <p>
      While of course it's possible that your user name is not registered; often
      this just means your ~/.cvspass got lost and/or that you haven't logged in.
      cvs login, and repeat the command.
    </p>

    <h3 id="section-10.6">10.6 What does '.pro' in 'unxlngi4.pro' mean ?</h3>

    <p>
      <i>Pro</i>duct &mdash; isn't it obvious ?
    </p>

    <h3 id="section-10.7">10.7 What does OpenOffice really look like ?</h3>

    <p>
       Today I found a photograph of it on my system, so I stuck it in here:
    </p>
    <img src="images/layers.png" alt="Abstraction Layers">

    <h3 id="section-10.8">10.8 How do I take a screenshot of OO.o ?</h3>
    <p>
       OOo does some very odd things with X resources, thus some conventional
       screenshot apps fail to take accurate shots. ImageMagick's 'import'
       however does a good job; use:
       <code>import foo.png</code> from the console, or
       <code>sleep 2; import -window root foo.png</code> instead.
       NB. unless you want your world to look tiny, you need to turn large
       toolbar icons first.
    </p>

    <h3 id="section-10.9">10.9 I tried to build with gcc on a prefix with BUILD in it why does it break ?</h3>
    <p>
      This is due to some very serious crack smoking going on in stlport.
      Essentially, there is some nasty header overriding, and they want to
      be able to fallback to the previous header (with the same name) - thus
      they have to hard-code the paths. To save doing that in lots of places,
      they use a #define, the #define has macro expansion done on it. Thus
      <b>if your gcc prefix contains an element which is a macro - you're stuffed</b>:
    </p>
    <p>
      stlport config header: <code>#define _STLP_NATIVE_INCLUDE_PATH \
        /home/michael/ximian-desktop/ooo/BUILD/ooo/include/c++/3.2.2</code>
      stlport helpful macros:<code># define _STLP_MAKE_HEADER(path, header) &lt;path/header&gt;
# define _STLP_NATIVE_CPP_C_HEADER(header)  \
        _STLP_MAKE_HEADER(_STLP_NATIVE_INCLUDE_PATH,header)</code> and finally
      stlport cunning native include: <code>#include _STLP_NATIVE_CPP_C_HEADER(foo)</code>
    </p>
    <p>
      Net result:
      <code>
      g++ ... -D<b>BUILD</b>=<b>7663</b> ...
      ...
from /home/michael/ximian-desktop/ooo/<b>BUILD</b>/ooo/OOO_1_0_2/xml2cmp/source/xcd/main.cxx:62:
/home/michael/ximian-desktop/ooo/<b>BUILD</b>/ooo/OOO_1_0_2/solver/641/unxlngi4.pro/inc/stl/cstddef:35:46:
/home/michael/ximian-desktop/ooo/<b>7663</b>/ooo/include/c++/3.2.2/cstddef: No such file or directory
      </code>
    </p>

    <h3 id="section-10.10">10.10 What are the UNO component XML descriptions for ?</h3>
    <p>
	Not much; worth installing, but currently highly under-used.
    </p>

    <h3 id="section-10.11">10.11 Why does the code look so ugly?</h3>
    <p>
      The authors must be using a really strange editor.
      It <em>thinks</em> tab stops are on every fourth column.
      Of course, the files come out ugly in Unix editors which <em>know</em>
      that tabs are eight characters wide.
    </p>
    <p>
      If you happen to use
      <a href="http://www.gnu.org/software/emacs/">a Real Editor</a>,
      we have some pink glasses to sell to you. Paste the contents of
      <a href="http://ooo.ximian.com/emacs.el">http://ooo.ximian.com/emacs.el</a>
      into your <tt>.emacs</tt>,
      or load it with a line like this: <tt>(load "/path/to/that/file.el")</tt>.
      Don't forget to adapt <tt>my-openoffice-path-regexp</tt> to your needs.
    </p>
    <p>
      Henceforth emacs will use 4-column tabs for your OOo source files.
      (And use <em>C++-Mode</em> for <tt>sdi</tt>-, <tt>hrc</tt>-,
      and <tt>src</tt>-files.)
    </p>

    <h2 id="section-11">11. Working with us</h2>
    <p>
      See the <a href="ooo-build.html">About ooo-build</a> document.
    </p>

  <hr>
  <p>If you have more hacking tips, corrections, a grip of correct
  spelling etc. please do mail <a href="http://www.gnome.org/~michael">me</a>,
  at <a href="mailto:michael.meeks@novell.com">michael.meeks@novell.com</a>.</p>
  </body>
</html>
