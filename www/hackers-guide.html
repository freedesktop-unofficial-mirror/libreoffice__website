<!doctype html PUBLIC "-//W3C//DTD HTML 4.0//EN">

<html lang="en">
  <head>
    <meta lang="en" http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>Unofficial OpenOffice Hacker's guide</title>
  </head>

  <body>
    <h1>Unofficial OpenOffice Hacker's guide</h1>

    <p>
      Building and hacking on OpenOffice.org (OO.o) entails climbing a
      fairly lengthy incline.  Hopefully this document will make the
      learning curve somewhat steeper and more abrupt, and will
      give you a walking stick to help you out.
    </p>

    <p>
      This document assumes that you'll be using a reasonably current
      Linux system, as a time saving feature.  Real hackers use <a
      href="http://www.gnu.org">Free software</a>, and don't have time
      to read about non-Free stuff.
    </p>

    <p>
      We aim to answer at least the following questions:
    </p>

    <ul>
	<li>How do I build OO.o</li>
	<li>How do I go around a development iteration</li>
	<li>How do I debug it</li>
	<li>How do I send a patch</li>
    </ul>

    <h2 id="section-0">0. Contents</h2>

    <ul>
	<li><a href="#section-1">1. Getting OO.o</a></li>
	<li><a href="#section-2">2. Building OO.o</a></li>
	<li><a href="#section-3">3. Installing OO.o</a></li>
	<li><a href="#section-4">4. Running OO.o</a></li>
	<li><a href="#section-5">5. Hacking OO.o</a></li>
	<li><a href="#section-6">6. Debugging OO.o</a></li>
	<li><a href="#section-7">7. Contributing patches</a></li>
	<li><a href="#section-8">8. Misc. tips</a></li>
	<li><a href="#section-9">9. Useful Links</a></li>
	<li><a href="#section-10">10. IFAQ</a></li>
	<li><a href="#section-12">11. Working with us</a></li>
    </ul>
    <p>
	This process is discussed in far more detail in the
	<a href="detailed-build-guide.html">detailed build guide</a>.
	We have however worked hard to make the process feasible for
	mere mortal programmers; and the easy description is what
	follows.
    </p>

    <h2 id="section-1">1. Getting OO.o</h2>

    <p>
      There are loads of competing versions of OO.o, and several
      choices of branch, with multiple outstanding patch sets.
      I recommend you build from CVS snapshots, that are known to
      build, and with patch sets against them that are known to
      apply. So to get the source do:
    </p>
    <pre>
    export CVSROOT=':pserver:anonymous@anoncvs.gnome.org:/cvs/gnome'
    cvs login
    cvs -z3 checkout openoffice
    </pre>
    <p>
      This will provide you with a copy of the ooo-build tree. If
      CVS scares you, you may be able to get a recent packaged
      version from <a href="packages">here</a>.
    </p>

    <p>
      <strong>Note:</strong> You are going to need ~4Gb of spare
      space to build it, and need to download ~200Mb of source to
      get this to build.
    </p>

    <h2 id="section-2">2. Building OO.o</h2>

    <h3 id="section-2.1">2.1. configure</h3>

    <p>
      The build process is pretty complicated; you have a choice
      of commands now; although running both won't actually hurt:
    </p>
    <pre>
      ./autogen.sh # the CVS version
      ./configure  # the packaged version
    </pre>
    <p>
      This will guess which branch snapshot you want to build; if
      you have other ideas use the --with-tag option; eg.
      <pre>--with-tag=OOO_1_0_3</pre> for the legacy branch.
    </p>

    <h3 id="section-2.2">2.2 download</h3>

    <p>
      By the time you've upgraded your system to the point that it
      has all the packages you need to start building OO.o (mozilla,
      recent libart etc. etc.) you're almost at the point that you
      can download the source. To do this, after a successful
      configure simply type: <pre>./download</pre> and wait.
    </p>

    <h3 id="section-2.3">make</h3>

    <p>
      This is the taxing bit - type <pre>make</pre> and don't forget
      to press enter. Quite possibly you want to log the output, so
      why not <pre>make 2>&1 | tee /tmp/log</pre>.
    </p>

    <h2 id="section-3">3. Installing OO.o</h2>

    <p>
      The result of a perfect build is a perfect zipped install set
      located in <pre>build/$TAG/instsetoo/unxlngi4.pro/01/normal/</pre>
      or similar. You can either manually run the setup program from
      there to install; <b>or</b> you can run <pre>sudo make install</pre>
      which will install OO.o to the system prefix for you.
    <p>

    <p>
      Having installed, you want to get in the mood for hacking by
      linking your build tree directly into the installed image, so
      by re-compiling a source sub-directory, you can simply re-run
      OO.o. This can get your build/test cycle down to a few tens of
      seconds. To do this do eg.
      <pre>bin/linkoo /usr/lib/ooo-1.0.3 /opt/openoffice/build/RC3_030729</pre>
    </p>

    <h2 id="section-4">4. Running OO.o</h2>

    <p>
      Wander into the prefix you just ran linkoo on; and do:
      <pre>cd program; . ./env</pre> this will setup your shell
      for running OO.o directly. Then simply <pre>soffice.bin</pre>
    </p>
    <p>
      <strong>Note:</strong> do not use <pre>./soffice.bin</pre>
      for reasons inscrutable this completely fails to work.
    </p>

    <h2 id="section-5">5. Hacking OO.o</h2>

    <h3 id="section-5.0">5.0. My first hack</h3>

    <p>
      So - we've built and run OO.o, and we want to prove to ourselves
      that it is in fact possible to hack on it. So in a new terminal
      do this:
    </p>
    <pre>
      cd build/$TAG
      . ./LinuxIntelEnv.Set.sh
      cd vcl
    </pre>
    <p>
      Now have a hack at vcl/source/window/toolbox.cxx; I suggest
      adding (eg.) an <pre>if (i%2)</pre> before the ImplDrawItem
      in ToolBox::Paint; save.
    </p>
    <p>
      You're still in vcl/ yes ? then type 'build debug=true'; wait
      for the scrolling text to stop; (5 seconds?). Now re-run
      <pre>soffice -writer</pre>. You should notice the effect.
    </p>

    <h3 id="section-5.1">5.1. Read the Fine manual</h3>

    <p>
      With the power of C++ comes the ability to shoot yourself in the
      foot all the more easily; (and implicitly), cf. <em>Holub,
      Rules for C and C++ programming, McGraw-Hill, 95</em>.
    </p>

    <p>
      The best way to prepare yourself for battle is to read the
      OpenOffice coding guidelines <a
      href="http://tools.openoffice.org/CodingGuidelines.sxw">
      here</a>, and for the easily confused c'tor / d'tor is short for
      constructor / destructor.
    </p>

    <h3 id="section-5.2">5.2. Sending patches</h3>

    <p>
      It is seldom clear which module a patch resides in in bugzilla.
      A quick way to try and work this out is to do:
    </p>

    <pre>
cvs status &lt;somefile&gt; | head
    </pre>

    <p>
      This should give a 'Repository Revision:' line, with a path, the
      2nd fragment of this is the project name.
    </p>

    <h3 id="section-5.3">5.3 Hacking the installer</h3>

    <p>
      Since the installer image deletes the (runnable) temporary setup
      image in <tt>/tmp/sv001.tmp</tt>, you have to stop it doing
      that. To do so, run setup / install with the -dontdeletetemp
      option.
    </p>

    <h3 id="section-5.4">5.4. Hacking other bits</h3>

    <p>
      Having got a working install, the best way to add your hacks is
      to symlink <tt>program/lib<em>foo</em>641li.so</tt> to the
      version you just built &mdash; most likely in
      <tt><em>foo</em>/unxlngi4.pro/lib/</tt>, then re-run the suite
      and your changes should be incorporated.
    </p>

    <p>
      For example; say you want to hack 'sal' the System Abstraction
      Layer and you've installed OOO_STABLE_1 into /opt/OOInstall you
      need to do:
    </p>

    <pre>
cd /opt/OOInstall/program
mkdir backup
mv libsal.so.3.0.1 backup
ln -s /opt/OpenOffice/OOO_STABLE_1/sal/unxlngi4.pro/lib/libsal.so.3.0.1 .
    </pre>

    <h3 id="section-5.5">5.5. Understanding D' make (man)</h3>

    <p>
      While the build system is in similar to may other systems, it
      is also perhaps slightly different. The overview is that each
      module is <i>built</i>, and then the results are <i>delivered</i>
      into the <a href="http://www.openoffice.org/dev_docs/source/solver.html">
      solver</a>. Each module builds against the headers
      in the solver. Thus there are a few intricacies.

      <ul>
        <li>
	  <i>build</i> &mdash; this perl script <i>solenv/bin/build.pl</i> is
	  used in conjunction with <a href="#section-5.5.2">prj/build.lst</a>
	  to ensure that every module that is needed is built first.<p>
	  build then un-winds internal module dependencies, and builds
	  each module with a chdir, dmake pair.
	</li>
	<li>
	  <i>deliver</i> &mdash; this perl script <i>solenv/bin/deliver.pl</i>
	  installs headers, and libraries (etc.) into the solver, as
	  informed by <a href="#section-5.5.3">prj/d.lst</a>. Crucially
	  deliver ensures that the date stamp on any file that is
	  installed to the solver is the same as that in the module's
	  directory. This ensures, that (particularly for headers) that
	  there is no dependency cascade triggering re-builds in other
	  modules.
	</li>
      </ul>
    </p>

    <h4 id="section-5.5.1">5.5.1 Standard directories</h3>

    <p>
      There are various standard directories and files in most of the
      modules that make up OO.o, here are some of the more useful:

      <ul>
        <li><b>prj</b>
	  <ul>
	    <li>
	       <i>build.lst</i> &mdash; this lists directories to be made,
	       '^#' comments are allowed, the order of the list is
	       immaterial see <a href="#section-5.5.2">detail</a>, it
	       is dictates <i>build</i>'s operation.
	    </li>
	    <li><i>d.lst</i> &mdash; this file describes the <i>deliver</i>
	       process, see <a href="#section-5.5.3">detail</a>.
	    </li>
	  </ul>
	</li>
	<li>
	  <b>util</b> &mdash; typically the util directory is charged with
	  glueing together the sub-libraries for each sub-module into
	  a single large library, adding system library dependencies,
	  building GUI resource files etc. All the work is described in
	  <i>makefile.mk</i>, this is usually the last directory to be
	  built in a project.
	</li>
	<li>
	  <b>inc</b> &mdash; public headers are typically separated
	  into an 'inc' directory, these will be installed into
	  the solver by the 'deliver' phase (using <i>prj/d.lst</i>)
	</li>
      </ul>
    </p>

    <p>
      There are also various file types that are (or are not)
      interesting:
      <ul>
        <li>
	  <b>makefile.rc</b> &mdash; these are ~all redundant, and can
	  safely be ignored.
	</li>
	<li>
	  <b>makefile.mk</b> &mdash; these in contrast are the 'dmake'
	  files, that are used to build each source directory.
	</li>
      </ul>
    </p>

    <h4 id="section-5.5.2">5.5.2 build.lst</h4>

    <p>
      On first view build.lst looks scary:
      <pre>
vc      vcl : nas freetype psprint rsc sot ucbhelper unotools sysui NULL
vc      vcl                      usr1   -       all     vc_mkout NULL
vc      vcl\source\unotypes      nmake  -       all     vc_unot NULL
vc      vcl\source\glyphs        nmake  -       all     vc_glyphs vc_unot NULL
      </pre>
      so we need to try and un-pack what's going on here, which is in fact not
      as odd as it might seem at first glance. Firstly lists are terminated
      by the 'NULL' string. Every line is prefixed by a shortcut which is
      irrelevant.<p>

      <ul>
         <li>
	   First active line contains a ':', this describes the
	   fact that this project (vcl) depends on these other modules
	   'nas', 'freetype', 'psprint' etc. to be built first. This is
	   for inter-project dependencies.
	 </li>
	 <li>
	   Then we have a redundant line 'usr1' [ for fun ? ], in fact
	   only lines containing the magic string 'nmake' are valid after
	   this.
	 </li>
	 <li>
	   The next lines describe internal project directory dependencies
	   and look like:
	     <pre>
[shortcut] [path to dir to build] nmake - [flags] [unique-name] [deps...] NULL
vc           vcl\source\glyphs    nmake -   all     vc_glyphs   vc_unot   NULL
	     </pre>
	   <i>shortcut</i> is not used; <i>flags</i> determines which platforms
	   this builds on; usually single char platform codes: 'dnpum' 'u' being
	   Unix. The higher up the system, the more stuff is flagged 'all'.<p>
	   <i>unique-name</i> this is a magic name, used by other lines to
	   describe an internal dependency. <i>deps...</i> any number of names of
	   other directories in this file, that must be built before this one.
	 </li>
      </ul>
      So we see in the vcl case that <i>vcl\source\unotypes</i> (vc_unot) has
      to be built before <i>vcl\source\glyphs</i> (vc_glyphs). It is
      <b>important</b> to understand that the order of the list is ~immaterial,
      and instead of a simple ordered list, we have a more complex internal
      dependency system &mdash; this contrasts with most other make systems.
    <p>
      There is also documentation <a href="http://tools.openoffice.org/tools/build.html">
      here</a> on it.
    <p>

    <h4 id="section-5.5.3">5.5.3 d.lst</h4>

    <p>
      The syntax of d.lst is more comprehensible than build.lst, it omits
      some default actions, such as copying build.lst into
      <i>inc/&lt;module&gt;/build.lst</i>.<p>
      A line is of the form:
      <pre>
[action]: [arguments]
mkdir:    %_DEST%\inc%_EXT%\external
      </pre>
      where if '[action]:' is omitted, it defaults to the 'copy' action.
      Typical actions are <i>copy</i>, <i>mkdir</i>, <i>touch</i>, <i>hedabu</i>,
      <i>dos</i> and <i>linklib</i>.<p>
      The 'hedabu' action is particularly interesting, inasmuch that it
      cosmetically re-formats the header to shrink it on install (otherwise
      it's much like the copy action).
      <p>
      During the action, various macro variables are expanded some of which are:
      <ul>
        <li>%__SRC% &mdash; distribution directory name eg. <i>unxlngi4.pro</i></li>
	<li>
	  %_DEST% &mdash; absolute path into solver eg.
	  <i>/opt/OpenOffice/OOO_STABLE_1/solver/641/unxlngi4.pro</i>
	</li>
	<li>
	  %_EXT% &mdash; (unusual) way of having minor updates eg. 641.1,
	  typically used to version every base sub-directory.
        </li>
      </ul>
      Typically then, if indeed you need to add a rule (cf. implicit
      directory copies), it will be of the form:
      <pre>
..\%__SRC%\inc\sal\*.h %_DEST%\inc%_EXT%\sal\*.h
      </pre>
      NB. relative paths are relative to the 'prj/' directory.
    </p>

    <h3 id="section-5.6">5.6 fast iteration</h3>

    <p>
      There are lots of ways to go round a devel iteration; eg. you
      can symlink libraries from the solver into your working install
      set; then with a 'build' / 'deliver' in a package, you can
      test your mods.
    </p>
    <p>
      One side-effect of this is (though) to force inter-module
      re-builds if you (cosmetically) changed a header. This can be
      avoided if you skip the 'deliver' stage, (only for those that
      know what they're doing), and symlink directly from the module's
      local build directory to the installed set. A script that helps
      you do this is <a href="linkoo">linkoo</a>, although it works
      only for a sub-set of libraries as yet. Having done this, you can
      simply do a 'build', then run the app on another console.
    </p>

    <h3 id="section-5.7">5.7 Can I get a <code>char *</code>, please?</h3>

    <p>
      Just barely.  OO.o has at least four string wrappers:
    </p>

    <ul>
      <li>
	<p>
	  <code>rtl_String</code> &mdash; sal/inc/rtl/string.h<br>
	  "Normal" string plus reference counting.
	  <code>rtlstring->buffer</code> is useful, as is
	  <code>rtlstring->length</code>.  This string has already
	  been converted to a particular character set; see
	  sal/inc/rtl/textenc.h &mdash; the only interesting cases are
	  <code>RTL_TEXTENCODING_UTF8</code> and perhaps
	  <code>RTL_TEXTENCODING_ASCII_US</code>
	  for real luddites.  Feel free to treat
	  <code>rtlstring->buffer</code> as your beloved <code>char *</code>.
	</p>
      </li>

      <li>
	<p>
	  <code>OString</code> &mdash; sal/inc/rtl/string.hxx<br>
	  Simply a rtl_String wrapped inside a <code>class</code>; you
	  can use <code>ostring.pData</code> to get at the rtl_String
	  (it's public).  <code>OString</code> has reasonably useful
	  methods for if you need them.
	</p>
      </li>

      <li>
	<p>
	  <code>rtl_uString</code> &mdash; sal/inc/rtl/ustring.h<br>
	  "Normal" Unicode string, similar to rtl_String, and
	  refcounted as well.  However, this one always comes in UCS-2
	  encoding, presumably to be compatible with Java's
	  questionable choices.
	</p>
      </li>

      <li>
	<p>
	  <code>OUString</code> &mdash; sal/inc/rtl/ustring.hxx<br> 
	  An rtl_uString wrapped inside a <code>class</code>.  This is
	  what most of the OO.o code uses to pass strings around.
	</p>
      </li>
    </ul>

    <p>
      Since real men use <code>char *</code> strings encoded in UTF-8;
      to use any system API such as 'printf' you need to extract a
      char * from a <code>OUString</code> use this:
    </p>

    <pre>
static char *
gimme_utf8_please (const rtl::OUString &amp;oustring)
{
	rtl::OString ostring;

	ostring = ::rtl::OUStringToOString (oustring, RTL_TEXTENCODING_UTF8);
        return strdup (ostring.pData->buffer);
}
    </pre>

    <p>
      And the reverse:
    </p>

    <pre>
static rtl::OUString
complicate_things_into_ucs2_please (const char *utf8_string)
{
	rtl::OString ostring;

        ostring = rtl::OString (utf8_string);
	return rtl::OStringToOUString (ostring, RTL_TEXTENCODING_UTF8);
}
    </pre>

    <h4 id="section-5.7.1">5.7.1. Pitfalls</h4>

    <p>
      <strong>Important</strong>  The rtl_String and rtl_uString
      APIs are massively clunky.  For the functions that create new
      strings, you <em>have</em> to set the original value of the
      string to NULL before calling them, like this:
    </p>

    <pre>
rtl_String *str;

str = NULL; /* If you don't do this, your program will crash */
rtl_string_newFromStr (&amp;str, "hello world");

rtl_uString *ustr;
ustr = NULL; /* Same as above */
rtl_uString_newFromAscii (&amp;str, "hello Unicode world");
    </pre>

    <p>
      This is because those functions attempt to first call the
      release() variants for the strings if they are not NULL &mdash;
      in principle to avoid memory leaks should you try to re-assign
      strings; in practice to make your life hard.
    </p>

    <h4 id="section-5.7.2">5.7.2. Examining strings from GDB</h4>

    <p>
      We have already seen that OO.o does not use humble <code>char *</code> 
      strings.  If you thought this was painful enough when writing
      code, wait until you have to debug it.  Here's how to get at
      your strings:
    </p>

    <ul>
      <li>rtl_String: just poke at it</li>
      <li>String: &mdash; note, the decl' of this uses the macro
          'UniString' to confuse readers of tools/inc/string.hxx,
	  <i>FIXME: need a macro to dump UniStrings nicely</i>
	  To convert programattically to something you can print
	  you probably want:
      <pre>
fprintf (stderr, "String is '%s'\n",
         (::rtl::OString (<i>MyString</i>.GetBuffer (),
	                  <i>MyString</i>.Len(),
			  RTL_TEXTENCODING_UTF8)).getStr());
      </pre>
      of course, you also need to include stdio.h and rtl/string.hxx if
they are missing.
      </li>
      <li>OString: <i>p str-&gt;pData</i></li>
      <li>OUString, rtl_uString: you're going to need this in your
      ~/.gdbinit:
      <pre>
define prtls
	set $poui = 0

	echo Building '$arg0'... 
	while $poui &lt; $arg0-&gt;length
		set $pouc = $arg0->buffer [$poui++]
		if $pouc &lt; 32 
			printf "\\0%o", $pouc
		else
			if $pouc &lt;= 127
				printf "%c", $pouc
			else 
				printf "\\0%o", $pouc
			end 
		end
	end
	echo \n
end

define pou
	prtls $arg0-&gt;pData
end
      </pre>
      NB. for reasons unknown gdb will take ~seconds to print a single string.
      Use <i>prtls</i> for 'rtl_uString *' and pou for 'OUString *'. To
      programatically print a OUString you need:
      <pre>
::rtl::OString tmpStr = OUStringToOString (<i>MyOUString</i>, RTL_TEXTENCODING_UTF8);
fprintf (stderr, "String is '%s'\n", tmpStr.getStr());
      </pre>
      </li>
    </ul>

    <h2 id="section-6">6. Debugging OO.o</h2>

    <p>
      This section assumes use of gdb, from the console.
    </p>

    <h3 id="section-6.1">6.1. Building with debugging symbols</h3>

    <p>
      OO.o includes a way to add debugging code in per module, via
      the <tt>build debug=true</tt> command in each module.
      Unfortunately this is not recommended to run for the whole
      project, and in addition to including vital debugging symbols
      it also includes scads of assertions, churning warnings, and
      various other checks.
    </p>
    <p>
      Thus if you want debugging symbols for everything, you have to
      hack several makefiles to add debugging symbols, [ NB. this
      makes the OO binaries ~1Gb small and the full build tree ~8Gb
      so beware ], apply this patch:
    </p>
    <pre>
--- solenv/inc/unxlngi4.mk
+++ solenv/inc/unxlngi4.mk
@@ -92,18 +92,18 @@ cc=gcc
 # do not use standard header search paths
 # if installed elsewhere
 .IF "$(BUILD_SOSL)"!=""
-CFLAGS=
+CFLAGS=-g
 .ENDIF
 CFLAGS+=-fmessage-length=0 -c $(INCLUDE)
 # flags for the C++ Compiler
-CFLAGSCC= -pipe -mcpu=pentiumpro
+CFLAGSCC= -g -pipe -mcpu=pentiumpro
 # Flags for enabling exception handling
 CFLAGSEXCEPTIONS=-fexceptions -fno-enforce-eh-specs
 # Flags for disabling exception handling
 CFLAGS_NO_EXCEPTIONS=-fno-exceptions
 
 # -fpermissive should be removed as soon as possible
-CFLAGSCXX= -pipe -mcpu=pentiumpro -fno-for-scope -fpermissive -fno-rtti 
+CFLAGSCXX= -g -pipe -mcpu=pentiumpro -fno-for-scope -fpermissive -fno-rtti 
 
 # HACK: enable Hamburg developers to build on glibc-2.2 machines but compile vs. glibc-2.1 headers
 .IF "$(BUILD_SOSL)"==""
    </pre>
    <p>
      Of course, without debugging symbols gdb becomes even more
      useless. To apply the patch cut and paste the above to /tmp/foo
      and in the base directory:
    </p>
    <pre>
patch -p0 < /tmp/foo
    </pre>

    <h3 id="section-6.2">6.2. Setting breakpoints</h3>

    <p>
      Due to the general level of brokenness in gdb, it's most likely
      that setting a breakpoint before running is unlikely to work;
      thus the best scheme is to:
    </p>

    <pre>
gdb ./soffice
break main
run # don't forget the arguments here
# ... traps in main ...
break osl_readFile
continue
    </pre>

    <p>
      Of course, this is never going to work if the code is
      implemented in a library that is dlopened later, which 
      accounts for the vast majority of OO code. Thus, you need
      to trap the code loading and then put the breakpoint in.
      To do that whack a breakpoint in osl_psz_loadModule, and
      suffer.
    </p>

    <p>
      Alternatively if you can instrument the code, it's pretty
      easy to add #include &lt;signal.h&gt; and then put a
      raise (SIGSTOP); somewhere in the code which will trap out
      in the debugger.
    </p>

    <h3 id="section-6.3">6.3. Starting at the beginning</h3>

    <p>
      We start in 'main' with a sal wrapper, that calls
      vcl/source/app/svmain.cxx (SVMain). It invokes Main on
      pSVData->mpApp; but pSVData is an in-line local. To
      debug this use the pImplSVData global variable. eg:
      <pre>
      p pImplSVData->maAppData
      </pre>
      This 'Main' method is typically:
      desktop/source/app/app.cxx (Main).
    </p>

    <h3 id="section-6.4">6.4. Examining strings</h3>

    <p>
      The humble char * (that gdb can natively display) is eschewed
      in the object world by wrapping it with innumerable different
      classes that gdb doesn't understand.  Worse, in many cases it
      is extremely difficult even to print the string &mdash; one consequence
      of the appalling decision to go with ucs-2 encoding. There
      are also both mutable and immutable string classes.
    </p>

    <p>
      Please read <a href="#section-5.7.2">section 5.7.2</a> to see
      how strings work in OO.o and to get some debugging tips.
    </p>

    <h3 id="section-6.5">6.5 Getting the build order right</h3>

    <p>
      The build dependencies of the modules are clearly crucial to
      getting a clean build. When you type 'build' in a module, first
      build examines prj/build.list, eg. neon/prj/build.lst:
      <pre>
xh      neon  :  soltools external expat NULL
      </pre>
      this specifies that 'soltools', 'external' and 'expat' have to
      be satisfactorily built and delivered before neon can be built.
      Occasionally these rules get broken, and people don't notice for
      a while.
    </p>

    <h3 id="section-6.6">6.6 It crashes, but only in gdb</h3>

    <p>
      What fun &mdash; you symlinked desktop/unxlngi4.pro/bin/soffice to
      soffice.bin in your install tree didn't you. That works fine
      if you just run it, but it seems gdb unpacks the symlink and
      passes a fully qualified path as argv[0], which defeats the
      hunting for the binary in the path, so it assigns the program
      base path as /opt/OpenOffice/OOO_STABLE_1/desktop/unxlngi4.pro/bin
      and starts looking for (eg. applicat.rdb) in there. Of course
      when it fails to find any setup information, it silently
      crashes somewhere else yards away from the original problem.
    </p>

    <h3 id="section-6.7">6.7 It crashes, but doesn't crash</h3>

    <p>
      For various reasons signal handlers are trapped and life
      can get rather confusing; thus it's best for builders to
      apply something like this:
<pre>
--- sal/osl/unx/signal.c
+++ sal/osl/unx/signal.c
@@ -188,6 +188,8 @@ static sal_Bool InitSignal()
             bSetILLHandler = sal_True;
        }
 
+       bSetSEGVHandler = bSetWINCHHandler = bSetILLHandler = bDoHardKill = sal_False;
+
        SignalListMutex = osl_createMutex();
 
        act.sa_handler = SignalHandlerFunction;

</pre>
      NB. trailing space.
    </p>

    <h3 id="section-6.8">6.8 I can't find the code from the trace</h3>

    <p>
      Some methods, are described as having a special linkage, such that
      they can be used in callbacks; these typically have a prefix:
      'LinkStub', so search for the latter part of the identifier in a
      freetext search. eg.
      <pre>
      IMPL_LINK( Window, ImplHandlePaintHdl, void*, EMPTYARG )
      </pre>
      builds the 'LinkStubImplHandlePaintHdl' method.
    </p>


    <h3 id="section-6.9">6.9 How can I re-build just the files I see in the trace</h3>

    <p>
      Often when you run gdb on a non-debugging build, you can't afford
      to wait, and re-compile (eg.) all of oowriter. Thus we have created
      a small perl helper, with which you can cut and paste method / class
      names you are interested in from the stack, and it'll touch just files
      containing those strings &mdash; for easier re-build. Here is a typical
      debugging workflow:
    </p>
    <pre>
    gdb ./soffice.bin
    ...
    bt
#0  0x40b4e0a1 in kill () from /lib/libc.so.6
#1  0x409acfe6 in raise () from /lib/libpthread.so.0
#2  0x447bcdbd in SfxMedium::DownLoad(Link const&) () from ./libsfx641li.so
#3  0x447be151 in SfxMedium::SfxMedium(String const&, unsigned short, unsigned char, SfxFilter const*, SfxItemSet*) ()
   from ./libsfx641li.so
#4  0x448339d3 in getCppuType(com::sun::star::uno::Reference<com::sun::star::document::XImporter> const*) () from ./libsfx641li.so
...
    quit
    cd base/OOO_STABLE_1/sfx2
    ootouch SfxMedium
    build debug=true
    </pre>
    <p>
      Thus, all files referencing / implementing anything with
      SfxMedium will be touched, and hence rebuilt with debugging
      symbols.
    </p>

    <h3 id="section-6.10">6.10 How can I re-build all the files in one source directory</h3>

    <p>
      If you want to recompile the code in just your current directory, you can
      use the killobj dmake target to remove the object files:
    </p>
    <pre>
    dmake killobj
    dmake
    </pre>

    <h3 id="section-6.11">6.11 It always crashes in sal_XErrorHdl</h3>

    <p>
      You are a victim of asynchronous X error reporting;
      <pre>export SAL_SYNCHRONIZE=1</pre> will make all the X traffic
      synchronous, and report the error by the method that caused it,
      it'll also make OO.o far slower, and the timing different.
    </p>

    <h3 id="section-6.12">6.12 It silently fails to load my word file</h3>
    <p>
      Caolan suggests: put breakpoints in ww8par.cxx top and tail of
      SwWW8ImplReader::LoadDoc, and confirm that the document gets as far
      as the import filter.
    </p>
    <p>
      A handy human place to put a breakpoint is in 
      SwWW8ImplReader::ReadPlainChars, you can see chunks of text as
      they are read in. Alternatively SwWW8ImplReader::AppendTxtNode as
      each paragraph is inserted.
    </p>

    <h2 id="section-7">7. Contributing patches</h2>

    <h3 id="section-7.1">7.1. Diff style</h3>

    <p>
      Always use unified diffs 'cvs -z3 diff -u', since they are the
      most readable, (and sensible) types of diff to read and apply.
    </p>

    <h3 id="section-7.2">7.2. Some interaction</h3>

    <p>
      It tends to be a good idea to work out how best to implement
      your fix, and/or discuss it with a developer or two before hand.
      Some of the best ways to do this are to post to <a
      href="mailto:dev@openoffice.org">dev@openoffice.org</a> or lurk
      on IRC at <tt>irc.freenode.net</tt> on the
      <tt>#OpenOffice.org</tt> channel. IRC is an awfully poor
      communication medium, but better than no communication.
    </p>

    <h2 id="section-8">8. Misc. tips</h2>

    <h3 id="section-8.1">8.1. Getting a CVS account</h3>

    <p>
      To see how the issue raising process works see eg. issue #7270.
      Having got the account setup, you need to tunnel to the secure
      CVS server something like:
    </p>

    <pre>
ssh -f -2 -P -L 2401:localhost:2401 tunnel@openoffice.org sleep 1400 < /dev/null > /dev/null
    </pre>

    <p>
      Then you need to change your CVSROOT to point at your local
      machine, since this is the endpoint of the tunnel:
    </p>

    <pre>
:pserver:mmeeks@localhost:/cvs
    </pre>

    <p>
      Login, and ... you'll soon notice that you'll need to migrate
      your CVS settings to the new server, to do this without wasting
      B/W with duplicate checkouts do: [ slow but effective ]
    </p>

    <pre>
echo ":pserver:&lt;account-name-here&gt;@localhost:/cvs" > tmp/Root
find -name 'Root' -exec cp /tmp/Root {} \;
find -name 'Repository' -exec perl -pi.bak -e 's/^oo\///' {} \;
    </pre>

  <h3 id="section-8.2">8.2 Using patch / diff</h3>

  <p>
    Patch/diff are a wonderful tools, however people often provide
    data that confuses them in a messy and difficult to un-tangle
    sort of a way. Here are some hints on untangling the mess:
  </p>
  <ul>
    <li>If at all unsure, run patch with --dry-run first, this will
        appear to do the patching action, but not actually do it
	[ this can give bogus results with compound inter-depending
	  patches, but is extremely useful ].
    <li>Mostly use patch -p0; 0 signifies the number of path
        elements to strip from the beginning of the file path the
	diff points at.
    <li>When you mess up, and have 1/2 of the patch applied and want
        to revert to clean, either remove the files and cvs update,
	or re-patch with the '-R' option, to reverse the effect.
    <li>Sometimes using diff between modules with lots of whitespace
        changes makes the patch hard to read; the '-w' flag to (cvs)
	diff makes this easier.
  </ul>

  <h3 id="section-8.3">8.3 Make clean</h3>

  <p>
    Just use <i>dmake clean</i> in the toplevel directory. In pre
    HEAD versions there was no 'clean' target so instead you had
    to do something (what dmake clean does now) like:
  </p>
<pre>
find -name 'unxlngi4.pro' -exec rm -Rf {} \;
</pre>

  <h3 id="section-8.4">8.4 CVS setup</h3>

  <p>
    In order to make efficient use of bandwidth, generate sensible
    diffs by default, and follow the trend, you need this in your
    ~/.cvsrc.
  </p>
<pre>
cvs -z3 -q
diff -upN 
update -dP
checkout -dP
status -v 
</pre>

    <h3 id="section-8.5">8.5. Adding header files to the build</h3>

    <p>
      Adding header files to the OO.o build is notoriously clunky.  To
      add header files under external/, make sure you list them in
      external/prj/d.lst so that they get copied under the
      solver/641/unxlngi4.pro/inc/external directory when building.
    </p>


    <h3 id="section-8.6">8.6. Finding where to hack</h3>

    <p>
      Often there is some GUI element used near the thing you're
      trying to locate / fix. So, find some sufficiently unusual
      string and search for it in <a href="http://ooo.ximian.com/lxr">LXR</a>'s
      <b>text</b> search; this should reveal an identifier related
      to that string; eg. SID_AUTOFORMAT, or FN_NUM_BULLET_ON.
      Having obtained that, do a new text search for that string,
      and you'll find the usage [ or a chained define to something
      else ]. For eg. menus/toolbar buttons the functionality is
      usually in a case statement eg. case SID_AUTOFORMAT: ...
    </p>
<!--
  <h3 id="section-8.X">8.X. Not failing at the first error</h3>

  <p>
    If you're leaving the computer for some time, and you know what
    you're doing, it can be worthwhile doing a make that skips minor
    build errors by using <pre>dmake -i</pre> ( similar to gmake -k ),
    however this can result in an apparently successful but broken
    build: not suitable for new builders.
  </p>
-->

    <h2 id="section-9">9. Useful links</h2>

    <h3 id="section-9.1">9.1. www.OpenOffice.org</h3>

    <p>
      While much of the initial openoffice.org structure seems not to
      be orientated towards hackers, there is much useful <a
      href="http://www.openoffice.org/documentation.html">
      documentation</a> if you dig for it.
    </p>

    <p>
      For OO.o news, and a distinctive perspective on OO.o see
      <a href="http://www.ooodocs.org">ooodocs.org</a>.
    </p>

    <p>
      Other related pages are:

      <a href="http://ooodi.sourceforge.net/">OOODI</a>a Gtk+ Dictionary installer.

      <a href="http://ooextras.sourceforge.net">OOExtras</a> provides
      extra templates, macros, and clip art.

      <a href="http://ooqstart.sourceforge.net">Quickstart applet</a> for GNOME
      (and <a href="http://segfaultskde.berlios.de/index.php?content=oooqs">KDE</a>).

      <a href="http://dict.progbits.com">Dictionaries &amp Docs</a> from Kevin Hendricks.
    <p>

    <h3 id="section-9.2">9.2. Patch archives</h3>

    <p>
      While productising various releases of OpenOffice, different
      projects have come up with (quite huge) patch sets against OO.o.
      Mercifully they are starting to get folded back in at a greater
      rate, so no patches should be necessary to HEAD to build
      it, similarly many have got into OOO_STABLE_1. It may be
      necessary to use some/all of these nevertheless.
    </p>

    <ul>
      <li>
	<a href="http://ooo.ximian.com">Ximian</a>'s OO.o patches and build
	tools / snapshots are all available as <a
	href="http://ooo.ximian.com/packages">packages</a>; or
	as <a href="http://ooo.ximian.com/patches">patches</a>.
      </li>
      <li>
	<a href="http://www.debian.org">Debian</a>'s helpful OO.o <a
	href="http://www.linux-debian.de/openoffice/">page</a>, with
	patches. And also Debian <a
	href="http://cvs.debian.org/oo-deb/debian/?cvsroot=debian-openoffice">
	CVS</a>.
      </li>
      <li>
	<a href="http://www.linux-mandrake.com">Mandrake</a>'s OO.o <a
        href="http://cvs.mandrakesoft.com/cgi-bin/cvsweb.cgi/SPECS/OpenOffice.org/">
        patch archive</a>.
      </li>
      <li>
        <a href="http://www.freebsd.org/cgi/cvsweb.cgi/ports/editors/openoffice/#dirlist">
	FreeBSD</a>'s OO.o port patches.
      </li>
      <li>
	Red Hat's .spec file (based on Mandrake's) is also worth a
	read, from their <a
	href="http://rawhide.redhat.com/pub/redhat/linux/rawhide/SRPMS/SRPMS/openoffice-1.0.1-6.src.rpm">SRPM</a>.
      </li>
      <li>
        People wanting to localize OO.o should study these
	<a href="ftp://ftp.linux.cz/pub/linux/people/pavel_janik/OpenOffice.org_1.0.1_CZ/build-13/build/Patches">
	patches</a> from Pavel Janik.
      </li>
    </ul>

    <h2 id="section-10">10. (Infrequently) FAQ</h2>

    <p>
      So no-one ever asked me these, I just made them up to astro-turf
      a bit (safer, wipe-clean, more durable questions).
    </p>

    <h3 id="section-10.1">10.1. Why do branches like 'mws_srx644' have odd numbers in them ?</h3>

    <p>
      By consulting various oracles, entrails etc. it transpires that
      in theory this number increments weekly, there being weekly
      freezes and hence solvers, development environments.  However -
      in recent time the process of solidifying a single build for
      wider release, has taken longer than a week &mdash; creating a
      quandary, and a mixed alphanumeric release tag. The 'mws' stands
      for 'Master Workspace'.
    </p>

    <h3 id="section-10.2">10.2. Why does the <b>build</b> require Java ?</h3>

    <p>
      Essentially it seems there are a lot of XML files involved in
      component registration, and various other services. It turns
      out that using Java is just an easy way to get this manipulation
      done simply. Also, Java can be used nicely at run-time if it's
      on the machine.
    </p>

    <h3 id="section-10.3">10.3. Why is [t]csh so broken ?</h3>

    <p>
      This is rather inscrutable; some particularly curious brokenness
      would be the way piping commands on stdin is crucially different
      to inputting them from the tty thus:
      <pre>echo 'echo #define DLL_NAME "libsch641li.so" >./foo.hxx' | /bin/tcsh -s</pre>
      fails to do anything whereas typing the same thing into the shell
      works just fine. Even more oddly:
      <pre>tcsh -fc 'echo #define DLL_NAME "libsch641li.so" >./foo.hxx'</pre>
      does do the right thing. See also <a
      href="http://www.faqs.org/faqs/unix-faq/shell/csh-whynot/">csh</a>.
    </p>

    <h3 id="section-10.4">10.4. I just tried to re-locate the build, why doesn't it work ?</h3>

    <p>
      The simple answer is: you need to run <pre>bin/relocate /path/to/new/build</pre>;
      another more complex answer is:
    </p>
    <p>
      Well, <b>assuming</b> you have re-configured things (LinuxIntelEnv.Set will
      need paths tweaking too &mdash; and re-importing to your shell) &mdash; then it's most 
      likely down to the ubiquitous non-relative paths, coded in lots
      of generated / built files, particularly '.dpc*' (dependency)
      files. Try:
      <pre>
find -name '*.dpc*' -exec rm {} \;
      </pre>
    </p>
    <p>
      The stlport does some really <a href="#section-10.10">broken</a> things, so
      you will also need to edit the 'stl_gcc.h' inside the solver/, and replace the
      two path instances there (see inc/stl/config/stl_gcc.h).
    </p>

    <h3 id="section-10.5">10.5 CVS says 'Fatal Error aborting. [acc] no such user', why ?</h3>

    <p>
      While of course it's possible that your user name is not registered; often
      this just means your ~/.cvspass got lost and/or that you haven't logged in.
      cvs login, and repeat the command.
    </p>

    <h3 id="section-10.6">10.6 What does '.pro' in 'unxlngi4.pro' mean ?</h3>

    <p>
      <i>Pro</i>duct &mdash; isn't it obvious ?
    </p>

    <h3 id="section-10.7">10.7 What does OpenOffice really look like ?</h3>

    <p>
       Today I found a photograph of it on my system, so I stuck it in here:
    </p>
    <img src="layers.png" alt="Abstraction Layers">

    <h3 id="section-10.8">10.8 How do I take a screenshot of OO.o ?</h3>
    <p>
       OOo does some very odd things with X resources, thus some conventional
       screenshot apps fail to take accurate shots. ImageMagick's 'import'
       however does a good job; use:
       <pre>import foo.png</pre> from the console, or
       <pre>sleep 2; import -window root foo.png</pre> instead.
       NB. unless you want your world to look tiny, you need to turn large
       toolbar icons first.
    </p>

    <h3 id="section-10.9">10.9 I tried to build with gcc on a prefix with BUILD in it why does it break ?</h3>
    <p>
      This is due to some very serious crack smoking going on in stlport.
      Essentially, there is some nasty header overriding, and they want to
      be able to fallback to the previous header (with the same name) - thus
      they have to hard-code the paths. To save doing that in lots of places,
      they use a #define, the #define has macro expansion done on it. Thus
      <b>if your gcc prefix contains an element which is a macro - you're stuffed</b>:
    </p>
    <p>
      stlport config header: <pre>#define _STLP_NATIVE_INCLUDE_PATH \
        /home/michael/ximian-desktop/ooo/BUILD/ooo/include/c++/3.2.2</pre>
      stlport helpful macros:<pre># define _STLP_MAKE_HEADER(path, header) &lt;path/header&gt;
# define _STLP_NATIVE_CPP_C_HEADER(header)  \
        _STLP_MAKE_HEADER(_STLP_NATIVE_INCLUDE_PATH,header)</pre> and finally
      stlport cunning native include: <pre>#include _STLP_NATIVE_CPP_C_HEADER(foo)</pre>
    </p>
    <p>
      Net result:
      <pre>
      g++ ... -D<b>BUILD</b>=<b>7663</b> ...
      ...
from /home/michael/ximian-desktop/ooo/<b>BUILD</b>/ooo/OOO_1_0_2/xml2cmp/source/xcd/main.cxx:62:
/home/michael/ximian-desktop/ooo/<b>BUILD</b>/ooo/OOO_1_0_2/solver/641/unxlngi4.pro/inc/stl/cstddef:35:46:
/home/michael/ximian-desktop/ooo/<b>7663</b>/ooo/include/c++/3.2.2/cstddef: No such file or directory
      </pre>
    </p>

    <h3 id="section-10.10">10.10 What are the UNO component XML descriptions for ?</h3>
    <p>
	Not much; worth installing, but currently highly under-used.
    </p>

    <h3 id="section-10.11">10.11 Why does the code look so ugly?</h3>
    <p>
      The authors must be using a really strange editor.
      It <em>thinks</em> tab stops are on every fourth column.
      Of course, the files come out ugly in Unix editors which <em>know</em>
      that tabs are eight characters wide.
    </p>
    <p>
      If you happen to use
      <a href="http://www.gnu.org/software/emacs/">a Real Editor</a>,
      we have some pink glasses to sell to you. Paste the contents of
      <a href="http://ooo.ximian.com/emacs.el">http://ooo.ximian.com/emacs.el</a>
      into your <tt>.emacs</tt>,
      or load it with a line like this: <tt>(load "/path/to/that/file.el")</tt>.
      Don't forget to adapt <tt>my-openoffice-path-regexp</tt> to your needs.
    </p>
    <p>
      Henceforth emacs will use 4-column tabs for your OOo source files.
      (And use <em>C++-Mode</em> for <tt>sdi</tt>-, <tt>hrc</tt>-,
      and <tt>src</tt>-files.)
    </p>

    <h2 id="section-11">11. Working with us</h2>
    <p>
      See the <a href="ooo-build.html">About ooo-build</a> document.
    </p>

  <hr>
  <p>If you have more hacking tips, corrections, a grip of correct
  spelling etc. please do mail <a href="http://www.gnome.org/~michael">me</a>,
  at <a href="mailto:michael@ximian.com">michael@ximian.com</a>.</p>
  </body>
</html>
